# リリースノート（v3.0.3）

## バージョン
- v3.0.3
- リリース日: 2024-07-13

## 主な変更点

### 🔧 技術的修正
- **セッション管理の大幅改善**
  - 大量の一時セッション生成問題を解決
  - フィンガープリントの安定性を向上
  - セッション再利用機能の実装
  - セッション状態の永続化強化

- **スコア抽出機能の大幅改善**
  - 自由記述形式のJSONブロック対応（`## 📊 評価スコア`）
  - 旧形式スコアブロック対応（`**スコア:**`）
  - 一般的なJSONブロック対応（フォールバック）
  - 正規表現フォールバック機能の強化
  - 複数のスコア形式に対応した段階的抽出

- **exercise_scoresテーブル対応の完全実装**
  - 新しいDB設計でのスコアデータ保存が正常動作
  - 学習履歴ページでのスコア表示エラーを修正
  - 新旧スコアデータ構造の互換性確保

- **自由記述ページの保存処理修正**
  - `database_adapter_v3.py`のStreamlitインポート不足を修正
  - 自由記述の回答・解説保存が正常動作
  - 重複保存防止機能の改善

- **キーワード生成のsession_id問題修正**
  - テーマ生成時のsession_idがnullになる問題を解決
  - 現在のセッションIDを適切に取得・保存
  - キーワード履歴との適切な紐付け

### 🔧 技術的改善
- **学習履歴ページのスコア処理改善**
  - 新しいDB設計のスコアデータ構造に対応
  - 旧形式（辞書）と新形式（リスト）の両方に対応
  - スコアの百分率計算を適切に実装

- **セッション管理の安定化**
  - 認証済みユーザーの適切なUUID使用
  - 匿名ユーザーのDB保存スキップ処理
  - セッション状態の詳細ログ追加

### 📊 データベース対応状況
- **exercise_scoresテーブル**: ✅ 完全対応
- **exercise_inputsテーブル**: ✅ 完全対応  
- **exercise_feedbackテーブル**: ✅ 完全対応
- **category_keyword_historyテーブル**: ✅ 完全対応
- **exercise_sessionsテーブル**: ✅ 完全対応

## セッション管理の改善詳細

### 修正内容
1. **フィンガープリントの安定性向上**
   - 既存フィンガープリントの再利用機能
   - セッション状態での永続化
   - 履歴保持数の削減（50件→20件）

2. **セッション再利用機能**
   - 既存セッションの有効性チェック（1時間以内）
   - セッション状態での永続化
   - フォールバックセッションの再利用

3. **一時セッション生成の制限**
   - 既存セッションの優先使用
   - セッションIDの永続化
   - 不要なセッション生成の防止

### 効果
- **大量の一時セッション生成問題を解決**
- **セッション管理の安定性向上**
- **パフォーマンスの改善**
- **ログの可読性向上**

## スコア抽出機能の詳細

### 対応形式
1. **自由記述形式**: `## 📊 評価スコア` の下のJSONブロック
2. **旧形式**: `**スコア:**` の下のJSONブロック  
3. **一般的なJSONブロック**: フォールバック用
4. **正規表現フォールバック**: `**項目名**: 数値` 形式

### 抽出例
```json
{"臨床的正確性": 8, "実践的思考": 7, "包括性": 9, "論理構成": 8}
```

## 互換性・注意事項

- 旧API/旧スキーマは**完全廃止**。今後は`database_v3.py`/`database_adapter_v3.py`のみ利用可能
- 旧API参照（import, コメント等）は**全て削除・禁止**
- 旧API用ファイル（database_adapter.py, database_v2.py等）は**物理的に削除済み**
- テスト・ドキュメントも新APIに統一
- 旧API互換が必要な場合は`database_adapter_v3.py`経由で自動変換

## 移行手順（参考）

1. データベーススキーマ移行（Supabase/SQL）
2. モジュール修正（v3系APIへの統一）
3. テスト・ドキュメント修正
4. 旧API/旧ファイルの削除
5. 本番動作確認

## 今後の予定

- より詳細な統計機能
- 学習進捗分析
- パフォーマンス最適化
- セキュリティ強化 