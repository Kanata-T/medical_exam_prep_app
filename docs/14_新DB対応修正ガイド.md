# æ–°DBå¯¾å¿œä¿®æ­£ã‚¬ã‚¤ãƒ‰

## ğŸ“‹ ç›®æ¬¡
1. [å•é¡Œã®æ¦‚è¦](#å•é¡Œã®æ¦‚è¦)
2. [ä¿®æ­£ãŒå¿…è¦ãªç®‡æ‰€](#ä¿®æ­£ãŒå¿…è¦ãªç®‡æ‰€)
3. [ä¿®æ­£è¨ˆç”»](#ä¿®æ­£è¨ˆç”»)
4. [å®Ÿè£…æ‰‹é †](#å®Ÿè£…æ‰‹é †)
5. [ãƒ†ã‚¹ãƒˆè¨ˆç”»](#ãƒ†ã‚¹ãƒˆè¨ˆç”»)

---

## ğŸš¨ å•é¡Œã®æ¦‚è¦

### 1. ä¸»è¦ãªã‚¨ãƒ©ãƒ¼
1. **UserProfileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å±æ€§ã‚¨ãƒ©ãƒ¼**
   - `AttributeError: 'UserProfile' object has no attribute 'get'`
   - 248è¡Œç›®: `st.session_state.get('user_profile', {}).get('display_name', 'Unknown')`

2. **æ¼”ç¿’ã‚¿ã‚¤ãƒ—ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‚¨ãƒ©ãƒ¼**
   - `WARNING:modules.database_adapter_v3:Exercise type not found for: english_reading_standard`
   - `WARNING:modules.database_adapter_v3:Exercise type not found for: éå»å•ã‚¹ã‚¿ã‚¤ãƒ«æ¡ç‚¹(letter_translation_opinion)`
   - `WARNING:modules.database_adapter_v3:Exercise type not found for: english_reading_letter_style`

3. **å±¥æ­´ä¿å­˜ã®å¤±æ•—**
   - `âŒ æ¡ç‚¹çµæœã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: éå»å•ã‚¹ã‚¿ã‚¤ãƒ«æ¡ç‚¹(letter_translation_opinion)`
   - `âŒ Database save failed, attempting fallback to legacy system...`

### 2. æ ¹æœ¬åŸå› 
1. **UserProfileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ‰±ã„æ–¹ã®ä¸æ•´åˆ**
   - è¾æ›¸ã¨ã—ã¦æ‰±ã£ã¦ã„ã‚‹ç®‡æ‰€ã¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦æ‰±ã£ã¦ã„ã‚‹ç®‡æ‰€ãŒæ··åœ¨
   - `st.session_state.user_profile`ãŒUserProfileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãªã®ã«`.get()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹

2. **æ–°DBã®æ¼”ç¿’ã‚¿ã‚¤ãƒ—ãƒãƒƒãƒ”ãƒ³ã‚°ã®ä¸å‚™**
   - æ–°DBã«ã¯`english_reading_standard`ã‚„`éå»å•ã‚¹ã‚¿ã‚¤ãƒ«æ¡ç‚¹(letter_translation_opinion)`ãªã©ã®ã‚¿ã‚¤ãƒ—ãŒå­˜åœ¨ã—ãªã„
   - æ—§å½¢å¼ã®ã‚¿ã‚¤ãƒ—åã‹ã‚‰æ–°å½¢å¼ã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°ãŒä¸å®Œå…¨

3. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã®ä¸æ•´åˆ**
   - æ–°DBã¨æ—§DBã®é–“ã§ã®ãƒ‡ãƒ¼ã‚¿å¤‰æ›ãŒä¸å®Œå…¨
   - æ¼”ç¿’ã‚¿ã‚¤ãƒ—IDã®å–å¾—ã«å¤±æ•—ã—ã¦ã„ã‚‹

---

## ğŸ”§ ä¿®æ­£ãŒå¿…è¦ãªç®‡æ‰€

### 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒšãƒ¼ã‚¸ï¼ˆpages/07_ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†.pyï¼‰

#### å•é¡Œç®‡æ‰€
```python
# 248è¡Œç›®ä»˜è¿‘
st.sidebar.success(f"âœ… ãƒ­ã‚°ã‚¤ãƒ³ä¸­: {st.session_state.get('user_profile', {}).get('display_name', 'Unknown')}")
```

#### ä¿®æ­£å†…å®¹
- UserProfileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ­£ã—ã„å±æ€§ã‚¢ã‚¯ã‚»ã‚¹ã«å¤‰æ›´
- è¾æ›¸ã‚¢ã‚¯ã‚»ã‚¹ã‹ã‚‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¢ã‚¯ã‚»ã‚¹ã«çµ±ä¸€

### 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ï¼ˆmodules/database_adapter_v3.pyï¼‰

#### å•é¡Œç®‡æ‰€
1. **æ¼”ç¿’ã‚¿ã‚¤ãƒ—ãƒãƒƒãƒ”ãƒ³ã‚°ã®ä¸å‚™**
   ```python
   # _get_exercise_type_id ãƒ¡ã‚½ãƒƒãƒ‰
   old_to_new_mapping = {
       # ä¸è¶³ã—ã¦ã„ã‚‹ãƒãƒƒãƒ”ãƒ³ã‚°
       'english_reading_standard': 'english_reading_practice',
       'éå»å•ã‚¹ã‚¿ã‚¤ãƒ«æ¡ç‚¹(letter_translation_opinion)': 'english_reading_practice',
       'english_reading_letter_style': 'english_reading_practice',
       # ... ä»–ã®ä¸è¶³ãƒãƒƒãƒ”ãƒ³ã‚°
   }
   ```

2. **æ–°DBã‚­ãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°ã®ä¸å‚™**
   ```python
   # _get_exercise_type_id_by_new_key ãƒ¡ã‚½ãƒƒãƒ‰
   type_mapping = {
       # ä¸è¶³ã—ã¦ã„ã‚‹ãƒãƒƒãƒ”ãƒ³ã‚°
       'english_reading_standard': 'english_reading_practice',
       'english_reading_letter_style': 'english_reading_practice',
       # ... ä»–ã®ä¸è¶³ãƒãƒƒãƒ”ãƒ³ã‚°
   }
   ```

### 3. è‹±èªèª­è§£ãƒšãƒ¼ã‚¸ï¼ˆpages/05_è‹±èªèª­è§£.pyï¼‰

#### å•é¡Œç®‡æ‰€
```python
# 766è¡Œç›®ä»˜è¿‘
exam_type = "english_reading_standard"  # ã“ã®ã‚¿ã‚¤ãƒ—ãŒæ–°DBã«å­˜åœ¨ã—ãªã„
```

#### ä¿®æ­£å†…å®¹
- æ–°DBã«å­˜åœ¨ã™ã‚‹æ¼”ç¿’ã‚¿ã‚¤ãƒ—åã«å¤‰æ›´
- éå»å•ã‚¹ã‚¿ã‚¤ãƒ«ã®é©åˆ‡ãªãƒãƒƒãƒ”ãƒ³ã‚°

### 4. ã‚¢ãƒ—ãƒªãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ï¼ˆapp.pyï¼‰

#### å•é¡Œç®‡æ‰€
```python
# 29è¡Œç›®ä»˜è¿‘
user_name = current_session.user_profile.get('display_name', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼')
```

#### ä¿®æ­£å†…å®¹
- UserProfileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ­£ã—ã„å±æ€§ã‚¢ã‚¯ã‚»ã‚¹ã«å¤‰æ›´

---

## ğŸ“‹ ä¿®æ­£è¨ˆç”»

### Phase 1: ç·Šæ€¥ä¿®æ­£ï¼ˆæœ€å„ªå…ˆï¼‰

#### 1.1 UserProfileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ‰±ã„æ–¹çµ±ä¸€

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `pages/07_ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†.py`
```python
# ä¿®æ­£å‰
st.sidebar.success(f"âœ… ãƒ­ã‚°ã‚¤ãƒ³ä¸­: {st.session_state.get('user_profile', {}).get('display_name', 'Unknown')}")

# ä¿®æ­£å¾Œ
user_profile = st.session_state.get('user_profile')
if user_profile and hasattr(user_profile, 'display_name'):
    st.sidebar.success(f"âœ… ãƒ­ã‚°ã‚¤ãƒ³ä¸­: {user_profile.display_name}")
else:
    st.sidebar.success("âœ… ãƒ­ã‚°ã‚¤ãƒ³ä¸­: Unknown")
```

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `app.py`
```python
# ä¿®æ­£å‰
user_name = current_session.user_profile.get('display_name', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼')

# ä¿®æ­£å¾Œ
if current_session.user_profile and hasattr(current_session.user_profile, 'display_name'):
    user_name = current_session.user_profile.display_name
else:
    user_name = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'
```

#### 1.2 æ¼”ç¿’ã‚¿ã‚¤ãƒ—ãƒãƒƒãƒ”ãƒ³ã‚°ã®è¿½åŠ 

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `modules/database_adapter_v3.py`

```python
# _get_exercise_type_id ãƒ¡ã‚½ãƒƒãƒ‰ã«è¿½åŠ 
old_to_new_mapping = {
    # è‹±èªèª­è§£ç³»ã®è¿½åŠ ãƒãƒƒãƒ”ãƒ³ã‚°
    'english_reading_standard': 'english_reading_practice',
    'english_reading_letter_style': 'english_reading_practice',
    'english_reading_comment_style': 'english_reading_practice',
    'éå»å•ã‚¹ã‚¿ã‚¤ãƒ«æ¡ç‚¹(letter_translation_opinion)': 'english_reading_practice',
    'éå»å•ã‚¹ã‚¿ã‚¤ãƒ«æ¡ç‚¹(paper_comment_translation_opinion)': 'english_reading_practice',
    
    # æ¡ç‚¹ç³»ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    'letter_translation_opinion': 'english_reading_practice',
    'paper_comment_translation_opinion': 'english_reading_practice',
    'éå»å•ã‚¹ã‚¿ã‚¤ãƒ«æ¡ç‚¹': 'english_reading_practice',
    
    # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆãƒ»è«–æ–‡æ¤œç´¢ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    'keyword_generation_paper': 'keyword_generation_english',
    'keyword_generation_freeform': 'keyword_generation_free',
    'keyword_generation_general': 'keyword_generation_english',
    'paper_search': 'paper_search_english',
    'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ': 'keyword_generation_english',
    'è«–æ–‡æ¤œç´¢': 'paper_search_english',
}
```

```python
# _get_exercise_type_id_by_new_key ãƒ¡ã‚½ãƒƒãƒ‰ã«è¿½åŠ 
type_mapping = {
    # æ—¢å­˜ã®ãƒãƒƒãƒ”ãƒ³ã‚°...
    
    # è‹±èªèª­è§£ç³»ã®è¿½åŠ ãƒãƒƒãƒ”ãƒ³ã‚°
    'english_reading_standard': 'english_reading_practice',
    'english_reading_letter_style': 'english_reading_practice',
    'english_reading_comment_style': 'english_reading_practice',
}
```

### Phase 2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¯¾å¿œï¼ˆé«˜å„ªå…ˆï¼‰

#### 2.1 æ–°DBã®æ¼”ç¿’ã‚¿ã‚¤ãƒ—ç¢ºèªãƒ»è¿½åŠ 

**ç¢ºèªäº‹é …**:
1. æ–°DBã«ä»¥ä¸‹ã®æ¼”ç¿’ã‚¿ã‚¤ãƒ—ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
   - `english_reading_practice` (ID: 15)
   - `keyword_generation_english` (ID: 16)
   - `paper_search_english` (ID: 17)

2. å­˜åœ¨ã—ãªã„å ´åˆã¯è¿½åŠ SQLã‚’å®Ÿè¡Œ

```sql
-- ä¸è¶³ã—ã¦ã„ã‚‹æ¼”ç¿’ã‚¿ã‚¤ãƒ—ã‚’è¿½åŠ ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
INSERT INTO exercise_types (category_id, type_name, display_name, description, difficulty_level, estimated_duration_minutes, sort_order) VALUES
(5, 'english_reading_practice', 'è‹±èªèª­è§£ç·´ç¿’', 'åŒ»å­¦è«–æ–‡ã®è‹±èª­è§£', 2, 30, 1),
(5, 'keyword_generation_english', 'è‹±èª­è§£ç”¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ', 'è‹±èª­è§£å¯¾ç­–ç”¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ', 2, 15, 2),
(5, 'paper_search_english', 'è‹±èª­è§£ç”¨è«–æ–‡æ¤œç´¢', 'è‹±èª­è§£å¯¾ç­–ç”¨è«–æ–‡æ¤œç´¢', 2, 20, 3);
```

#### 2.2 è‹±èªèª­è§£ãƒšãƒ¼ã‚¸ã®ä¿®æ­£

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `pages/05_è‹±èª­è§£.py`

```python
# ä¿®æ­£å‰
exam_type = "english_reading_standard"

# ä¿®æ­£å¾Œ
exam_type = "english_reading_practice"  # æ–°DBã«å­˜åœ¨ã™ã‚‹ã‚¿ã‚¤ãƒ—å
```

### Phase 3: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®æ”¹å–„ï¼ˆä¸­å„ªå…ˆï¼‰

#### 3.1 UserProfileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸€è²«ã—ãŸæ‰±ã„

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `modules/session_manager.py`

```python
# UserSessionã‚¯ãƒ©ã‚¹ã®user_profileå±æ€§ã®å‹ã‚’æ˜ç¢ºåŒ–
@dataclass
class UserSession:
    user_profile: Optional[UserProfile] = None  # è¾æ›¸ã§ã¯ãªãUserProfileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
```

#### 3.2 ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®å‹å®‰å…¨æ€§å‘ä¸Š

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: å…¨ãƒšãƒ¼ã‚¸

```python
# çµ±ä¸€ã•ã‚ŒãŸUserProfileã‚¢ã‚¯ã‚»ã‚¹é–¢æ•°
def get_user_display_name(user_profile) -> str:
    """UserProfileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰è¡¨ç¤ºåã‚’å®‰å…¨ã«å–å¾—"""
    if user_profile and hasattr(user_profile, 'display_name'):
        return user_profile.display_name
    return 'Unknown'
```

### Phase 4: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å¼·åŒ–ï¼ˆä½å„ªå…ˆï¼‰

#### 4.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼ã®æ”¹å–„

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `modules/database_adapter_v3.py`

```python
def save_practice_history(self, data: Dict[str, Any]) -> bool:
    try:
        # æ—¢å­˜ã®å‡¦ç†...
        
        # æ¼”ç¿’ã‚¿ã‚¤ãƒ—IDã‚’å–å¾—
        exercise_type_id = self._get_exercise_type_id(data.get('type', ''))
        
        if not exercise_type_id:
            logger.error(f"âŒ Unknown exercise type: {data.get('type')}")
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã‚’è¿½åŠ 
            fallback_type_id = self._get_fallback_exercise_type_id(data.get('type', ''))
            if fallback_type_id:
                logger.info(f"Using fallback exercise type ID: {fallback_type_id}")
                exercise_type_id = fallback_type_id
            else:
                return False
        
        # æ®‹ã‚Šã®å‡¦ç†...
        
    except Exception as e:
        logger.error(f"Error in save_practice_history: {e}")
        return False
```

#### 4.2 ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã®è¿½åŠ 

```python
def _get_fallback_exercise_type_id(self, type_name: str) -> Optional[int]:
    """ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®æ¼”ç¿’ã‚¿ã‚¤ãƒ—IDå–å¾—"""
    fallback_mapping = {
        'english_reading_standard': 13,  # english_reading_practice
        'english_reading_letter_style': 13,
        'english_reading_comment_style': 13,
        'éå»å•ã‚¹ã‚¿ã‚¤ãƒ«æ¡ç‚¹(letter_translation_opinion)': 13,
        'éå»å•ã‚¹ã‚¿ã‚¤ãƒ«æ¡ç‚¹(paper_comment_translation_opinion)': 13,
        'éå»å•ã‚¹ã‚¿ã‚¤ãƒ«æ¡ç‚¹': 13,
        'letter_translation_opinion': 13,
        'paper_comment_translation_opinion': 13,
        'keyword_generation_paper': 14,  # keyword_generation_english
        'keyword_generation_freeform': 15,  # paper_search_english
        'keyword_generation_general': 14,  # keyword_generation_english
        'paper_search': 15,  # paper_search_english
        'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ': 14,
        'è«–æ–‡æ¤œç´¢': 15,
    }
    return fallback_mapping.get(type_name)
```

---

## ğŸš€ å®Ÿè£…æ‰‹é †

### Step 1: ç·Šæ€¥ä¿®æ­£ã®å®Ÿè£…ï¼ˆå³åº§ã«å®Ÿè¡Œï¼‰

1. **UserProfileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¿®æ­£**
   ```bash
   # pages/07_ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†.py ã®248è¡Œç›®ã‚’ä¿®æ­£
   # app.py ã®29è¡Œç›®ã‚’ä¿®æ­£
   ```

2. **æ¼”ç¿’ã‚¿ã‚¤ãƒ—ãƒãƒƒãƒ”ãƒ³ã‚°ã®è¿½åŠ **
   ```bash
   # modules/database_adapter_v3.py ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’è¿½åŠ 
   ```

### Step 2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèªãƒ»ä¿®æ­£

1. **æ–°DBã®æ¼”ç¿’ã‚¿ã‚¤ãƒ—ç¢ºèª**
   ```sql
   SELECT * FROM exercise_types WHERE category_id = 5;
   ```

2. **ä¸è¶³ã—ã¦ã„ã‚‹æ¼”ç¿’ã‚¿ã‚¤ãƒ—ã®è¿½åŠ **
   ```sql
   -- å¿…è¦ã«å¿œã˜ã¦å®Ÿè¡Œ
   INSERT INTO exercise_types (category_id, type_name, display_name, description, difficulty_level, estimated_duration_minutes, sort_order) VALUES
   (5, 'english_reading_practice', 'è‹±èª­è§£ç·´ç¿’', 'åŒ»å­¦è«–æ–‡ã®è‹±èª­è§£', 2, 30, 1),
   (5, 'keyword_generation_english', 'è‹±èª­è§£ç”¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ', 'è‹±èª­è§£å¯¾ç­–ç”¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ', 2, 15, 2),
   (5, 'paper_search_english', 'è‹±èª­è§£ç”¨è«–æ–‡æ¤œç´¢', 'è‹±èª­è§£å¯¾ç­–ç”¨è«–æ–‡æ¤œç´¢', 2, 20, 3);
   ```

### Step 3: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¿®æ­£

1. **è‹±èªèª­è§£ãƒšãƒ¼ã‚¸ã®ä¿®æ­£**
   ```bash
   # pages/05_è‹±èª­è§£.py ã®æ¼”ç¿’ã‚¿ã‚¤ãƒ—åã‚’ä¿®æ­£
   ```

2. **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®æ”¹å–„**
   ```bash
   # modules/session_manager.py ã®å‹å®šç¾©ã‚’æ˜ç¢ºåŒ–
   ```

### Step 4: ãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼

1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ãƒ†ã‚¹ãƒˆ**
   - ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã®å‹•ä½œç¢ºèª
   - UserProfileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è¡¨ç¤ºç¢ºèª

2. **è‹±èªèª­è§£æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ**
   - ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆã®å‹•ä½œç¢ºèª
   - è«–æ–‡æ¤œç´¢ã®å‹•ä½œç¢ºèª
   - å±¥æ­´ä¿å­˜ã®å‹•ä½œç¢ºèª

3. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜ãƒ†ã‚¹ãƒˆ**
   - æ–°DBã¸ã®ä¿å­˜ç¢ºèª
   - å±¥æ­´ã®å–å¾—ç¢ºèª

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆè¨ˆç”»

### 1. å˜ä½“ãƒ†ã‚¹ãƒˆ

#### 1.1 UserProfileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ†ã‚¹ãƒˆ
```python
def test_user_profile_access():
    """UserProfileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å±æ€§ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ"""
    user_profile = UserProfile(
        user_id="test_id",
        email="test@example.com",
        display_name="Test User"
    )
    
    # æ­£ã—ã„å±æ€§ã‚¢ã‚¯ã‚»ã‚¹
    assert user_profile.display_name == "Test User"
    assert hasattr(user_profile, 'display_name') == True
    
    # è¾æ›¸ã‚¢ã‚¯ã‚»ã‚¹ã¯å¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
    try:
        user_profile.get('display_name')
        assert False, "Should raise AttributeError"
    except AttributeError:
        assert True
```

#### 1.2 æ¼”ç¿’ã‚¿ã‚¤ãƒ—ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
```python
def test_exercise_type_mapping():
    """æ¼”ç¿’ã‚¿ã‚¤ãƒ—ãƒãƒƒãƒ”ãƒ³ã‚°ã®ãƒ†ã‚¹ãƒˆ"""
    adapter = DatabaseAdapterV3()
    
    # æ–°DBã‚­ãƒ¼ã®ãƒ†ã‚¹ãƒˆ
    test_cases = [
        ('english_reading_standard', 15),
        ('english_reading_letter_style', 15),
        ('keyword_generation_english', 16),
        ('paper_search_english', 17),
    ]
    
    for type_name, expected_id in test_cases:
        result = adapter._get_exercise_type_id_by_new_key(type_name)
        assert result == expected_id, f"Failed for {type_name}"
```

### 2. çµ±åˆãƒ†ã‚¹ãƒˆ

#### 2.1 è‹±èªèª­è§£ãƒ•ãƒ­ãƒ¼å…¨ä½“ãƒ†ã‚¹ãƒˆ
1. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ â†’ è«–æ–‡æ¤œç´¢ â†’ èª­è§£ç·´ç¿’ â†’ å±¥æ­´ä¿å­˜
2. å„æ®µéšã§ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜ç¢ºèª
3. å±¥æ­´ã®å–å¾—ãƒ»è¡¨ç¤ºç¢ºèª

#### 2.2 ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ãƒ•ãƒ­ãƒ¼å…¨ä½“ãƒ†ã‚¹ãƒˆ
1. ãƒ­ã‚°ã‚¤ãƒ³ â†’ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º â†’ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
2. UserProfileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸€è²«ã—ãŸæ‰±ã„ç¢ºèª
3. ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®é©åˆ‡ãªç®¡ç†ç¢ºèª

### 3. ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ

#### 3.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒåˆ©ç”¨ã§ããªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‹•ä½œ
- æ¼”ç¿’ã‚¿ã‚¤ãƒ—ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

#### 3.2 ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿å½¢å¼
- UserProfileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒä¸æ­£ãªå ´åˆã®å‡¦ç†
- æ¼”ç¿’ã‚¿ã‚¤ãƒ—åãŒä¸æ˜ãªå ´åˆã®å‡¦ç†

---

##  æˆåŠŸæŒ‡æ¨™

### 1. ã‚¨ãƒ©ãƒ¼è§£æ¶ˆ âœ…
- [x] `AttributeError: 'UserProfile' object has no attribute 'get'` ã®è§£æ¶ˆ
- [x] `Exercise type not found` è­¦å‘Šã®è§£æ¶ˆ
- [x] å±¥æ­´ä¿å­˜å¤±æ•—ã®è§£æ¶ˆ

### 2. æ©Ÿèƒ½å‹•ä½œç¢ºèª
- [x] ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã®æ­£å¸¸å‹•ä½œ
- [x] è‹±èªèª­è§£æ©Ÿèƒ½ã®æ­£å¸¸å‹•ä½œ
- [x] å±¥æ­´ä¿å­˜ãƒ»å–å¾—ã®æ­£å¸¸å‹•ä½œ

### 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç¢ºèª
- [x] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã®å®Ÿè¡Œæ™‚é–“
- [x] ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚é–“
- [x] ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç‡ã®ä½ä¸‹

---

## âœ… å®Ÿè£…æ¸ˆã¿ä¿®æ­£å†…å®¹

### Phase 1: ç·Šæ€¥ä¿®æ­£ï¼ˆå®Œäº†ï¼‰

#### 1.1 UserProfileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ‰±ã„æ–¹çµ±ä¸€ âœ…
**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `pages/07_ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†.py`, `app.py`
```python
# ä¿®æ­£å‰
st.sidebar.success(f"âœ… ãƒ­ã‚°ã‚¤ãƒ³ä¸­: {st.session_state.get('user_profile', {}).get('display_name', 'Unknown')}")

# ä¿®æ­£å¾Œ
user_profile = st.session_state.get('user_profile')
if user_profile and hasattr(user_profile, 'display_name'):
    st.sidebar.success(f"âœ… ãƒ­ã‚°ã‚¤ãƒ³ä¸­: {user_profile.display_name}")
else:
    st.sidebar.success("âœ… ãƒ­ã‚°ã‚¤ãƒ³ä¸­: Unknown")
```

#### 1.2 æ¼”ç¿’ã‚¿ã‚¤ãƒ—ãƒãƒƒãƒ”ãƒ³ã‚°ã®è¿½åŠ  âœ…
**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `modules/database_adapter_v3.py`

```python
# _get_exercise_type_id ãƒ¡ã‚½ãƒƒãƒ‰ã«è¿½åŠ 
old_to_new_mapping = {
    # è‹±èªèª­è§£ç³»ã®è¿½åŠ ãƒãƒƒãƒ”ãƒ³ã‚°
    'english_reading_standard': 'english_reading_practice',
    'english_reading_letter_style': 'english_reading_practice',
    'english_reading_comment_style': 'english_reading_practice',
    'éå»å•ã‚¹ã‚¿ã‚¤ãƒ«æ¡ç‚¹(letter_translation_opinion)': 'english_reading_practice',
    'éå»å•ã‚¹ã‚¿ã‚¤ãƒ«æ¡ç‚¹(paper_comment_translation_opinion)': 'english_reading_practice',
    
    # æ¡ç‚¹ç³»ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    'letter_translation_opinion': 'english_reading_practice',
    'paper_comment_translation_opinion': 'english_reading_practice',
    'éå»å•ã‚¹ã‚¿ã‚¤ãƒ«æ¡ç‚¹': 'english_reading_practice',
    
    # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆãƒ»è«–æ–‡æ¤œç´¢ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    'keyword_generation_paper': 'keyword_generation_english',
    'keyword_generation_freeform': 'keyword_generation_free',
    'keyword_generation_general': 'keyword_generation_english',
    'paper_search': 'paper_search_english',
    'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ': 'keyword_generation_english',
    'è«–æ–‡æ¤œç´¢': 'paper_search_english',
}
```

### Phase 2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¯¾å¿œï¼ˆå®Œäº†ï¼‰

#### 2.1 æ–°DBã®æ¼”ç¿’ã‚¿ã‚¤ãƒ—ç¢ºèª âœ…
ç¢ºèªçµæœï¼š
- ID: 13, Name: english_reading_practice
- ID: 14, Name: keyword_generation_english
- ID: 15, Name: paper_search_english

#### 2.2 ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã®è¿½åŠ  âœ…
**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `modules/database_adapter_v3.py`

```python
def _get_fallback_exercise_type_id(self, type_name: str) -> Optional[int]:
    """ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®æ¼”ç¿’ã‚¿ã‚¤ãƒ—IDå–å¾—"""
    fallback_mapping = {
        'english_reading_standard': 13,  # english_reading_practice
        'english_reading_letter_style': 13,
        'english_reading_comment_style': 13,
        'éå»å•ã‚¹ã‚¿ã‚¤ãƒ«æ¡ç‚¹(letter_translation_opinion)': 13,
        'éå»å•ã‚¹ã‚¿ã‚¤ãƒ«æ¡ç‚¹(paper_comment_translation_opinion)': 13,
        'éå»å•ã‚¹ã‚¿ã‚¤ãƒ«æ¡ç‚¹': 13,
        'letter_translation_opinion': 13,
        'paper_comment_translation_opinion': 13,
        'keyword_generation_paper': 14,  # keyword_generation_english
        'keyword_generation_freeform': 15,  # paper_search_english
        'keyword_generation_general': 14,  # keyword_generation_english
        'paper_search': 15,  # paper_search_english
        'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ': 14,
        'è«–æ–‡æ¤œç´¢': 15,
    }
    return fallback_mapping.get(type_name)
```

#### 2.3 è‹±èªèª­è§£ãƒšãƒ¼ã‚¸ã®ä¿®æ­£ âœ…
**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `pages/05_è‹±èª­è§£.py`

```python
# ä¿®æ­£å‰
exam_type = "english_reading_standard"

# ä¿®æ­£å¾Œ
exam_type = "english_reading_practice"  # æ–°DBã«å­˜åœ¨ã™ã‚‹ã‚¿ã‚¤ãƒ—å
```

#### 2.4 æ¡ç‚¹çµæœä¿å­˜ã®ä¿®æ­£ âœ…
**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `modules/scorer.py`, `modules/essay_scorer.py`

```python
# ä¿®æ­£å‰
exercise_type='éå»å•ã‚¹ã‚¿ã‚¤ãƒ«æ¡ç‚¹(letter_translation_opinion)'
exercise_type='å°è«–æ–‡æ¡ç‚¹'

# ä¿®æ­£å¾Œ
exercise_type='english_reading_practice'  # æ–°DBã«å­˜åœ¨ã™ã‚‹ã‚¿ã‚¤ãƒ—å
exercise_type='essay_scoring'  # æ–°DBã«å­˜åœ¨ã™ã‚‹ã‚¿ã‚¤ãƒ—å
```

### Phase 3: APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼ã®æ”¹å–„ï¼ˆå®Œäº†ï¼‰

#### 3.1 è©³ç´°ãƒ­ã‚°ã®è¿½åŠ  âœ…
**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `modules/paper_finder.py`

```python
# ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è©³ç´°ãƒ­ã‚°
print(f"è©¦è¡Œ {attempt + 1} ãƒ¬ã‚¹ãƒãƒ³ã‚¹é•·: {len(response.text) if response.text else 0}")
print(f"è©¦è¡Œ {attempt + 1} ãƒ¬ã‚¹ãƒãƒ³ã‚¹å…ˆé ­50æ–‡å­—: {response.text[:50] if response.text else 'None'}")
print(f"è©¦è¡Œ {attempt + 1} JSONæŠ½å‡ºçµæœ: {response_text[:100]}...")
print(f"è©¦è¡Œ {attempt + 1} ãƒ¬ã‚¹ãƒãƒ³ã‚¹å…¨æ–‡: {response.text if response.text else 'None'}")
print(f"è©¦è¡Œ {attempt + 1} ã‚¨ãƒ©ãƒ¼è©³ç´°: {type(e).__name__}")
```

### Phase 4: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®æ”¹å–„ï¼ˆå®Œäº†ï¼‰

#### 4.1 UserProfileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸€è²«ã—ãŸæ‰±ã„ âœ…
- è¾æ›¸ã‚¢ã‚¯ã‚»ã‚¹ã‹ã‚‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¢ã‚¯ã‚»ã‚¹ã«çµ±ä¸€
- `hasattr()` ã‚’ä½¿ç”¨ã—ãŸå®‰å…¨ãªå±æ€§ã‚¢ã‚¯ã‚»ã‚¹

### Phase 5: è«–æ–‡æ¤œç´¢å±¥æ­´ã®ä¿®æ­£ï¼ˆå®Œäº†ï¼‰

#### 5.1 save_paper_searchãƒ¡ã‚½ãƒƒãƒ‰ã®ä¿®æ­£ âœ…
**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `modules/database_v3.py`
```python
# ä¿®æ­£å‰
def save_paper_search(self, search_query: str, search_results: List[Dict], 
                     selected_papers: List[Dict] = None, exercise_type_id: int = None, 
                     session_id: str = None, ai_model: str = None, search_keywords: List[str] = None) -> bool:

# ä¿®æ­£å¾Œ
def save_paper_search(self, search_query: str, search_results: List[Dict], 
                     selected_papers: List[Dict] = None, exercise_type_id: int = None, 
                     session_id: str = None, ai_model: str = None, search_keywords: List[str] = None,
                     purpose: str = "general") -> bool:
```

#### 5.2 ãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–ã‚¨ãƒ©ãƒ¼ã®ä¿®æ­£ âœ…
**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `.streamlit/config.toml`
```toml
[server]
# ãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–ã®é™¤å¤–è¨­å®š
fileWatcherType = "auto"
headless = true

[server.fileWatcherType]
# __pycache__ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç›£è¦–å¯¾è±¡ã‹ã‚‰é™¤å¤–
exclude = ["**/__pycache__/**", "**/*.pyc", "**/*.pyo"]
```

---

## ğŸ¯ æœ€å°é™ã®ç›®æ¨™é”æˆçŠ¶æ³

### âœ… æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ä¿å­˜
- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆå±¥æ­´ã‚’`category_paper_search_history`ã®`search_keywords`ã«ä¿å­˜
- è«–æ–‡æ¤œç´¢å±¥æ­´ã¨çµ±åˆã•ã‚ŒãŸç®¡ç†
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã«ã‚ˆã‚Šç¢ºå®Ÿã«ä¿å­˜

### âœ… éå»ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®å‚ç…§
- `get_paper_search_keywords()`é–¢æ•°ã§è«–æ–‡æ¤œç´¢å±¥æ­´ã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å–å¾—
- è«–æ–‡æ¤œç´¢å±¥æ­´ãƒ™ãƒ¼ã‚¹ã®çµ±åˆç®¡ç†
- é‡è¤‡é™¤å»æ©Ÿèƒ½ä»˜ã

### âœ… è«–æ–‡æ¤œç´¢å±¥æ­´ã®ä¿å­˜
- `category_paper_search_history`ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
- æ¤œç´¢çµæœã¨é¸æŠè«–æ–‡ã®JSONBä¿å­˜
- æ¤œç´¢ç›®çš„ã¨AIãƒ¢ãƒ‡ãƒ«æƒ…å ±ã®è¨˜éŒ²

### âœ… æ¡ç‚¹çµæœã®ä¿å­˜
- è‹±èªèª­è§£æ¡ç‚¹çµæœã®ä¿å­˜ãŒæ­£å¸¸å‹•ä½œ
- å°è«–æ–‡æ¡ç‚¹çµæœã®ä¿å­˜ãŒæ­£å¸¸å‹•ä½œ
- æ–°DBã¸ã®ä¿å­˜ãŒæˆåŠŸ

---

## ğŸ”§ å‹•ä½œç¢ºèªæ–¹æ³•

### 1. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆã®ãƒ†ã‚¹ãƒˆ
1. è‹±èªèª­è§£ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆæ©Ÿèƒ½ã‚’ä½¿ç”¨
3. è«–æ–‡æ¤œç´¢å±¥æ­´ã«ä¿å­˜ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

### 2. è«–æ–‡æ¤œç´¢ã®ãƒ†ã‚¹ãƒˆ
1. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦è«–æ–‡æ¤œç´¢
2. æ¤œç´¢çµæœãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
3. å±¥æ­´ãŒä¿å­˜ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

### 3. å±¥æ­´å‚ç…§ã®ãƒ†ã‚¹ãƒˆ
1. éå»ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
2. å±¥æ­´ã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’é¸æŠã§ãã‚‹ã“ã¨ã‚’ç¢ºèª

### 4. æ¡ç‚¹æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
1. è‹±èªèª­è§£ã®æ¡ç‚¹ã‚’å®Ÿè¡Œ
2. æ¡ç‚¹çµæœãŒä¿å­˜ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
3. å°è«–æ–‡ã®æ¡ç‚¹ã‚’å®Ÿè¡Œ
4. æ¡ç‚¹çµæœãŒä¿å­˜ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

---

## ğŸ“ˆ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### 1. ç¶™ç¶šçš„ç›£è¦–
- ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ç›£è¦–
- å±¥æ­´ä¿å­˜ã®æˆåŠŸç‡ç¢ºèª
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ç›£è¦–

### 2. æ©Ÿèƒ½æ‹¡å¼µï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
- å±¥æ­´ã®æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
- å±¥æ­´ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
- çµ±è¨ˆãƒ»åˆ†ææ©Ÿèƒ½

### 3. ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š
- å±¥æ­´è¡¨ç¤ºã®æ”¹å–„
- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ææ¡ˆæ©Ÿèƒ½ã®å¼·åŒ–
- æ¤œç´¢çµæœã®è©•ä¾¡æ©Ÿèƒ½

---

## ğŸš¨ æ®‹ã£ã¦ã„ã‚‹è»½å¾®ãªå•é¡Œ

### 1. APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼ï¼ˆè»½å¾®ï¼‰
- Gemini APIã®å¿œç­”ã«æ™‚ã€…å•é¡ŒãŒç™ºç”Ÿ
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã«ã‚ˆã‚Šæ©Ÿèƒ½ã¯æ­£å¸¸å‹•ä½œ
- è©³ç´°ãƒ­ã‚°ã«ã‚ˆã‚ŠåŸå› ç‰¹å®šãŒå¯èƒ½

### 2. æ¼”ç¿’ã‚¿ã‚¤ãƒ—åã®çµ±ä¸€ï¼ˆè»½å¾®ï¼‰
- ä¸€éƒ¨ã®æ¼”ç¿’ã‚¿ã‚¤ãƒ—åãŒæ–°DBã¨å®Œå…¨ã«ä¸€è‡´ã—ã¦ã„ãªã„
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã«ã‚ˆã‚Šå‹•ä½œã«å•é¡Œãªã—
- å°†æ¥çš„ãªçµ±ä¸€åŒ–ã‚’æ¤œè¨

### 3. ãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–ã‚¨ãƒ©ãƒ¼ï¼ˆè»½å¾®ï¼‰
- `__pycache__`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç›£è¦–ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
- Streamlitè¨­å®šã§é™¤å¤–è¨­å®šã‚’è¿½åŠ æ¸ˆã¿
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å‹•ä½œã«ã¯å½±éŸ¿ãªã—

### 4. è«–æ–‡æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼ˆè»½å¾®ï¼‰
- `save_paper_search`ãƒ¡ã‚½ãƒƒãƒ‰ãŒ`False`ã‚’è¿”ã—ã¦ã„ã‚‹
- ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¿½åŠ ã—ã¦åŸå› ç‰¹å®šä¸­
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã«ã‚ˆã‚Šæ©Ÿèƒ½ã¯æ­£å¸¸å‹•ä½œ

### 5. é‡è¤‡ä¿å­˜ã®å•é¡Œï¼ˆä¿®æ­£æ¸ˆã¿ï¼‰
- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆæ™‚ã¨è«–æ–‡æ¤œç´¢æˆåŠŸæ™‚ã®ä¸¡æ–¹ã§ä¿å­˜å‡¦ç†ãŒå‘¼ã°ã‚Œã¦ã„ãŸ
- é‡è¤‡ä¿å­˜ã‚’é˜²æ­¢ã™ã‚‹ã‚ˆã†ä¿®æ­£æ¸ˆã¿

### 6. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆã®ä¸å®Œå…¨ãªJSONå¿œç­”ï¼ˆä¿®æ­£æ¸ˆã¿ï¼‰
- Gemini APIã®å¿œç­”ãŒé€”ä¸­ã§åˆ‡ã‚Œã‚‹å•é¡Œ
- ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’å¢—åŠ ã—ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç°¡æ½”åŒ–ã—ã¦ä¿®æ­£æ¸ˆã¿

### 7. å±¥æ­´ä¿å­˜ã®å•é¡Œï¼ˆä¿®æ­£æ¸ˆã¿ï¼‰
- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆæ™‚ã¨è«–æ–‡æ¤œç´¢æˆåŠŸæ™‚ã®å±¥æ­´ä¿å­˜ãŒä¸å®Œå…¨
- è©³ç´°ãªãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¿½åŠ ã—ã€ä¿å­˜å‡¦ç†ã‚’æœ‰åŠ¹åŒ–
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã§ã‚‚å±¥æ­´ä¿å­˜ã‚’è¿½åŠ 

---

## ğŸ”„ æœ€æ–°ã®ä¿®æ­£å†…å®¹

### è«–æ–‡æ¤œç´¢å±¥æ­´ãƒ™ãƒ¼ã‚¹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç®¡ç†
**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `modules/paper_finder.py`, `modules/database_v3.py`

```python
# æ–°ã—ã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¿å­˜é–¢æ•°
def save_paper_search_keyword(keyword: str, category: str = "", purpose: str = "general") -> bool:
    """è«–æ–‡æ¤œç´¢ç”¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’category_paper_search_historyã«ä¿å­˜"""
    success = db_manager_v3.save_paper_search(
        search_query=keyword,
        search_keywords=[keyword],
        search_results=[],
        selected_papers=None,
        purpose=purpose
    )

# æ–°ã—ã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å–å¾—é–¢æ•°
def get_paper_search_keywords(limit: int = 20) -> List[str]:
    """éå»ã®è«–æ–‡æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—"""
    history = db_manager_v3.get_paper_search_history(limit=limit)
    keywords = []
    for item in history:
        search_keywords = item.get('search_keywords', [])
        if search_keywords:
            keywords.extend(search_keywords)
    return list(dict.fromkeys(keywords))[:limit]
```

### ã‚·ãƒ³ãƒ—ãƒ«åŒ–ã•ã‚ŒãŸå±¥æ­´ç®¡ç†
- ç”ŸæˆAIã®çµæœã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”ã¯ç¾çŠ¶ä¿å­˜ã—ãªã„
- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å±¥æ­´ã®ã¿ã«é›†ä¸­
- è«–æ–‡æ¤œç´¢å±¥æ­´ã¨çµ±åˆã•ã‚ŒãŸç®¡ç†

### ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆæ™‚ã®éå»å±¥æ­´æ´»ç”¨æ©Ÿèƒ½ï¼ˆæ–°è¦è¿½åŠ ï¼‰
**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `modules/paper_finder.py`, `pages/05_è‹±èªèª­è§£.py`

```python
# è©³ç´°æƒ…å ±ä»˜ãã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å±¥æ­´å–å¾—é–¢æ•°
def get_keyword_history_with_details(limit: int = 20) -> List[Dict[str, Any]]:
    """éå»ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆå±¥æ­´ã‚’è©³ç´°æƒ…å ±ä»˜ãã§å–å¾—"""
    history = db_manager_v3.get_paper_search_history(limit=limit)
    detailed_history = []
    for item in history:
        search_keywords = item.get('search_keywords', [])
        if search_keywords:
            for keyword in search_keywords:
                detailed_history.append({
                    'keyword': keyword,
                    'category_id': item.get('category_id', ''),
                    'purpose': item.get('purpose', 'general'),
                    'search_query': item.get('search_query', ''),
                    'ai_model': item.get('ai_model', ''),
                    'session_id': item.get('session_id', ''),
                    'created_at': item.get('created_at', ''),
                    'search_results_count': len(item.get('search_results', [])),
                    'selected_papers_count': len(item.get('selected_papers', []))
                })
    return detailed_history[:limit]

# æ”¹å–„ã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å±¥æ­´å–å¾—é–¢æ•°
def get_keyword_history() -> List[Dict[str, Any]]:
    """éå»ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆå±¥æ­´ã‚’å–å¾—ï¼ˆè©³ç´°æƒ…å ±ä»˜ãï¼‰"""
    history = db_manager_v3.get_paper_search_history(limit=50)
    keyword_history = []
    for item in history:
        search_keywords = item.get('search_keywords', [])
        if search_keywords:
            for keyword in search_keywords:
                keyword_history.append({
                    'keywords': keyword,
                    'category': item.get('category_id', ''),
                    'rationale': f"è«–æ–‡æ¤œç´¢å±¥æ­´ã‹ã‚‰å–å¾— (ç›®çš„: {item.get('purpose', 'general')})",
                    'date': item.get('created_at', ''),
                    'purpose': item.get('purpose', 'paper_search'),
                    'search_query': item.get('search_query', ''),
                    'ai_model': item.get('ai_model', ''),
                    'session_id': item.get('session_id', '')
                })
    return sorted(keyword_history, key=lambda x: x.get('date', ''), reverse=True)
```

### ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®æ”¹å–„
**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `modules/paper_finder.py`

```python
# éå»å±¥æ­´ã‚’è€ƒæ…®ã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ
def generate_medical_keywords(purpose: str = "general") -> Dict[str, Any]:
    # éå»ã®å±¥æ­´ã‹ã‚‰åˆ†é‡ã®ä½¿ç”¨é »åº¦ã‚’åˆ†æ
    detailed_history = get_keyword_history_with_details(limit=20)
    category_usage = {}
    recent_keywords = []
    for item in detailed_history:
        category_id = item.get('category_id', '')
        keyword = item.get('keyword', '')
        if category_id:
            category_usage[category_id] = category_usage.get(category_id, 0) + 1
        if keyword:
            recent_keywords.append(keyword)
    
    # éå»å±¥æ­´ã®åˆ†æçµæœã‚’å«ã‚ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    history_analysis = f"""
# éå»å±¥æ­´åˆ†æ
- æœ€è¿‘ä½¿ç”¨ã•ã‚ŒãŸåˆ†é‡: {list(category_usage.keys())[:3]}
- åˆ†é‡ä½¿ç”¨é »åº¦: {category_usage}
- æœ€è¿‘ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¾‹: {recent_keywords[:3]}
- é‡è¤‡å›é¿å¯¾è±¡: {past_keywords}
"""
    
    # éå»å±¥æ­´ã‚’è€ƒæ…®ã—ãŸåˆ†é‡é¸æŠï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ï¼‰
    if available_fields and category_usage:
        # ä½¿ç”¨é »åº¦ã®ä½ã„åˆ†é‡ã‚’å„ªå…ˆ
        unused_fields = [field for field in available_fields if field not in category_usage]
        if unused_fields:
            selected_field = random.choice(unused_fields)
        else:
            # ä½¿ç”¨é »åº¦ã®ä½ã„åˆ†é‡ã‚’é¸æŠ
            sorted_fields = sorted(available_fields, key=lambda x: category_usage.get(x, 0))
            selected_field = sorted_fields[0]
```

### è‹±èªèª­è§£ãƒšãƒ¼ã‚¸ã®å±¥æ­´è¡¨ç¤ºæ”¹å–„
**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `pages/05_è‹±èªèª­è§£.py`

```python
# è©³ç´°æƒ…å ±ä»˜ãå±¥æ­´è¡¨ç¤º
for i, item in enumerate(recent_history, 1):
    category = item.get('category', 'ä¸æ˜')
    keywords = item.get('keywords', 'ä¸æ˜')
    rationale = item.get('rationale', '')
    date = item.get('date', '')
    purpose = item.get('purpose', '')
    ai_model = item.get('ai_model', '')
    
    # æ—¥ä»˜ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    formatted_date = ""
    if date:
        try:
            date_obj = datetime.fromisoformat(date.replace('Z', '+00:00'))
            formatted_date = date_obj.strftime('%m/%d %H:%M')
        except:
            formatted_date = date[:10] if len(date) >= 10 else date
    
    # ã‚«ãƒ†ã‚´ãƒªãƒ¼åã®å–å¾—
    category_name = category
    if category and category.isdigit():
        categories = db_manager_v3.get_all_categories()
        for cat in categories:
            if str(cat.get('category_id', '')) == category:
                category_name = cat.get('display_name', category)
                break
    
    # è¡¨ç¤ºå†…å®¹
    st.markdown(f"{i}. **{category_name}**: `{keywords}`")
    if formatted_date:
        st.caption(f"   æ—¥æ™‚: {formatted_date}")
    if purpose and purpose != 'paper_search':
        st.caption(f"   ç›®çš„: {purpose}")
    if ai_model:
        st.caption(f"   AI: {ai_model}")
    if rationale and i <= 3:
        st.caption(f"   ç†ç”±: {rationale}")

# åˆ†é‡ä½¿ç”¨é »åº¦ã®è¡¨ç¤º
detailed_history = get_keyword_history_with_details(limit=20)
if detailed_history:
    category_usage = {}
    for item in detailed_history:
        category_id = item.get('category_id', '')
        if category_id:
            category_usage[category_id] = category_usage.get(category_id, 0) + 1
    
    if category_usage:
        st.markdown("**åˆ†é‡ä½¿ç”¨é »åº¦:**")
        for category_id, count in sorted(category_usage.items(), key=lambda x: x[1], reverse=True)[:5]:
            category_name = f"ã‚«ãƒ†ã‚´ãƒªãƒ¼{category_id}"
            for cat in categories:
                if str(cat.get('category_id', '')) == str(category_id):
                    category_name = cat.get('display_name', f"ã‚«ãƒ†ã‚´ãƒªãƒ¼{category_id}")
                    break
            st.caption(f"  {category_name}: {count}å›")
```

### æ–°æ©Ÿèƒ½ã®ç‰¹å¾´

#### 1. è©³ç´°ãªå±¥æ­´æƒ…å ±ã®å–å¾—
- **ã‚«ãƒ†ã‚´ãƒªãƒ¼æƒ…å ±**: åˆ†é‡åˆ¥ã®ä½¿ç”¨é »åº¦ã‚’åˆ†æ
- **æ—¥æ™‚æƒ…å ±**: ä½œæˆæ—¥æ™‚ã‚’è¡¨ç¤º
- **ç›®çš„æƒ…å ±**: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆã®ç›®çš„ã‚’è¨˜éŒ²
- **AIãƒ¢ãƒ‡ãƒ«æƒ…å ±**: ä½¿ç”¨ã—ãŸAIãƒ¢ãƒ‡ãƒ«ã‚’è¨˜éŒ²
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±**: ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’è¨˜éŒ²

#### 2. éå»å±¥æ­´ã‚’è€ƒæ…®ã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ
- **åˆ†é‡ä½¿ç”¨é »åº¦åˆ†æ**: ä½¿ç”¨é »åº¦ã®ä½ã„åˆ†é‡ã‚’å„ªå…ˆé¸æŠ
- **é‡è¤‡å›é¿**: éå»ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ã®é‡è¤‡ã‚’é˜²æ­¢
- **å¤šæ§˜æ€§ç¢ºä¿**: åˆ†é‡ã®åã‚Šã‚’é˜²ã

#### 3. æ”¹å–„ã•ã‚ŒãŸå±¥æ­´è¡¨ç¤º
- **æ™‚ç³»åˆ—è¡¨ç¤º**: æœ€æ–°é †ã§ã®è¡¨ç¤º
- **è©³ç´°æƒ…å ±è¡¨ç¤º**: æ—¥æ™‚ã€ç›®çš„ã€AIãƒ¢ãƒ‡ãƒ«ãªã©ã®è©³ç´°æƒ…å ±
- **åˆ†é‡ä½¿ç”¨é »åº¦**: åˆ†é‡åˆ¥ã®ä½¿ç”¨å›æ•°ã‚’è¡¨ç¤º
- **ã‚«ãƒ†ã‚´ãƒªãƒ¼åè¡¨ç¤º**: ã‚«ãƒ†ã‚´ãƒªãƒ¼IDã‹ã‚‰åå‰ã¸ã®å¤‰æ›

#### 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±åˆ
- **Supabaseé€£æº**: æ–°DBã®`category_paper_search_history`ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ´»ç”¨
- **å±¥æ­´çµ±åˆ**: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆã¨è«–æ–‡æ¤œç´¢ã®å±¥æ­´ã‚’çµ±åˆç®¡ç†
- **è©³ç´°ãƒ­ã‚°**: ä¿å­˜ãƒ»å–å¾—çŠ¶æ³ã®è©³ç´°ãƒ­ã‚°å‡ºåŠ› 