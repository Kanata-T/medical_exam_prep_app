# „Éá„Éº„Çø„Éô„Éº„Çπ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÉªÂà∂Á¥ÑË©≥Á¥∞Ë®≠Ë®à

## üìã ÁõÆÊ¨°
1. [„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπË®≠Ë®àÊà¶Áï•](#„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπË®≠Ë®àÊà¶Áï•)
2. [Âà∂Á¥ÑË®≠Ë®à](#Âà∂Á¥ÑË®≠Ë®à)
3. [„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©Âåñ](#„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©Âåñ)
4. [Áõ£Ë¶ñ„Éª„É°„É≥„ÉÜ„Éä„É≥„Çπ](#Áõ£Ë¶ñ„É°„É≥„ÉÜ„Éä„É≥„Çπ)

---

## üîç „Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπË®≠Ë®àÊà¶Áï•

### 1. ‰∏ªË¶Å„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÔºàÈ´òÈ†ªÂ∫¶„ÇØ„Ç®„É™ÂØæÂøúÔºâ

```sql
-- ===== PRIMARY PERFORMANCE INDEXES =====

-- 1. „É¶„Éº„Ç∂„ÉºÁ∑¥ÁøíÂ±•Ê≠¥ÂèñÂæóÔºàÊúÄÈ†ª„ÇØ„Ç®„É™Ôºâ
CREATE INDEX idx_practice_sessions_user_history 
ON practice_sessions(user_id, created_at DESC, status) 
WHERE status = 'completed';

-- 2. Á∑¥Áøí„Çø„Ç§„ÉóÂà•Â±•Ê≠¥
CREATE INDEX idx_practice_sessions_user_type_date 
ON practice_sessions(user_id, practice_type_id, created_at DESC)
WHERE status = 'completed';

-- 3. „Çª„ÉÉ„Ç∑„Éß„É≥Ë©≥Á¥∞„Éá„Éº„ÇøÂèñÂæó
CREATE INDEX idx_practice_inputs_session_type 
ON practice_inputs(session_id, input_type, input_order);

CREATE INDEX idx_practice_scores_session_category 
ON practice_scores(session_id, score_category);

CREATE INDEX idx_practice_feedback_session 
ON practice_feedback(session_id, feedback_type);

-- 4. Áµ±Ë®à„ÉªÂàÜÊûê„ÇØ„Ç®„É™Áî®
CREATE INDEX idx_user_analytics_performance 
ON user_analytics(user_id, practice_type_id, latest_session_date DESC);

-- 5. „ÉÜ„Éº„ÉûÂà•Ê§úÁ¥¢ÔºàËá™Áî±Ë®òËø∞Áî®Ôºâ
CREATE INDEX idx_practice_sessions_theme 
ON practice_sessions(practice_type_id, theme, created_at DESC)
WHERE theme IS NOT NULL AND theme != '';

-- ===== SPECIALIZED INDEXES =====

-- 6. „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çª„ÉÉ„Ç∑„Éß„É≥ÁÆ°ÁêÜ
CREATE INDEX idx_active_sessions 
ON practice_sessions(user_id, start_time DESC) 
WHERE status = 'in_progress';

-- 7. ÊúÄËøë„ÅÆÂÆå‰∫Ü„Çª„ÉÉ„Ç∑„Éß„É≥Ôºà30Êó•‰ª•ÂÜÖÔºâ
CREATE INDEX idx_recent_sessions 
ON practice_sessions(user_id, practice_type_id, end_time DESC) 
WHERE status = 'completed' 
AND end_time > NOW() - INTERVAL '30 days';

-- 8. „Çπ„Ç≥„Ç¢ÂàÜÊûêÁî®
CREATE INDEX idx_scores_analysis 
ON practice_scores(score_category, score_percentage, created_at DESC);

-- 9. ÂÖ•Âäõ„Éá„Éº„ÇøÂàÜÊûêÁî®
CREATE INDEX idx_inputs_analysis 
ON practice_inputs(input_type, word_count, created_at DESC);
```

### 2. Ë§áÂêà„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÔºàË§áÈõë„Å™„ÇØ„Ç®„É™ÂØæÂøúÔºâ

```sql
-- ===== COMPOSITE INDEXES FOR COMPLEX QUERIES =====

-- 1. „É¶„Éº„Ç∂„ÉºÈÄ≤Êçó„Éà„É©„ÉÉ„Ç≠„É≥„Ç∞
CREATE INDEX idx_user_progress_tracking 
ON practice_sessions(user_id, practice_type_id, status, created_at DESC, duration_seconds);

-- 2. „ÉÜ„Éº„ÉûÂàÜÊûêÁî®
CREATE INDEX idx_theme_analysis 
ON practice_sessions(practice_type_id, theme, completion_percentage DESC, created_at DESC)
WHERE status = 'completed' AND theme IS NOT NULL;

-- 3. „Çπ„Ç≥„Ç¢Áµ±Ë®àÁî®
CREATE INDEX idx_score_statistics 
ON practice_scores(score_category, score_percentage, created_at DESC)
INCLUDE (session_id, feedback);

-- 4. „Çª„ÉÉ„Ç∑„Éß„É≥Ë©≥Á¥∞ÂàÜÊûê
CREATE INDEX idx_session_details 
ON practice_sessions(user_id, practice_type_id, status, duration_seconds, completion_percentage)
WHERE status IN ('completed', 'abandoned');
```

### 3. Ê§úÁ¥¢„Éª„Éï„Ç£„É´„Çø„É™„É≥„Ç∞Áî®„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ

```sql
-- ===== SEARCH AND FILTERING INDEXES =====

-- 1. „Éï„É´„ÉÜ„Ç≠„Çπ„ÉàÊ§úÁ¥¢ÔºàPostgreSQL GINÔºâ
CREATE INDEX idx_feedback_fulltext 
ON practice_feedback USING gin(to_tsvector('japanese', feedback_content));

CREATE INDEX idx_inputs_fulltext 
ON practice_inputs USING gin(to_tsvector('japanese', content));

-- 2. ÈÉ®ÂàÜÊñáÂ≠óÂàóÊ§úÁ¥¢
CREATE INDEX idx_theme_search 
ON practice_sessions USING gin(theme gin_trgm_ops)
WHERE theme IS NOT NULL;

-- 3. „É°„Çø„Éá„Éº„ÇøÊ§úÁ¥¢ÔºàJSONBÔºâ
CREATE INDEX idx_session_metadata 
ON practice_sessions USING gin(metadata);

CREATE INDEX idx_input_metadata 
ON practice_inputs USING gin(metadata);

-- 4. Êó•‰ªòÁØÑÂõ≤Ê§úÁ¥¢
CREATE INDEX idx_sessions_date_range 
ON practice_sessions(created_at, user_id, practice_type_id)
WHERE status = 'completed';

-- 5. „Çπ„Ç≥„Ç¢ÁØÑÂõ≤Ê§úÁ¥¢
CREATE INDEX idx_scores_range 
ON practice_scores(score_percentage, score_category, created_at DESC);
```

### 4. „Éë„Éº„ÉÜ„Ç£„Ç∑„Éß„É≥ÂØæÂøú„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ

```sql
-- ===== PARTITION-AWARE INDEXES =====

-- 1. ÊúàÊ¨°„Éë„Éº„ÉÜ„Ç£„Ç∑„Éß„É≥ÂØæÂøú
CREATE INDEX idx_sessions_monthly_user 
ON practice_sessions(user_id, practice_type_id, created_at DESC)
LOCAL; -- „Éë„Éº„ÉÜ„Ç£„Ç∑„Éß„É≥ÊØé„Å´‰ΩúÊàê

-- 2. „É¶„Éº„Ç∂„ÉºÂà•„Éë„Éº„ÉÜ„Ç£„Ç∑„Éß„É≥ÂØæÂøúÔºàÂ∞ÜÊù•„ÅÆÊã°ÂºµÁî®Ôºâ
CREATE INDEX idx_sessions_user_partition 
ON practice_sessions(practice_type_id, created_at DESC, status);
```

---

## üîí Âà∂Á¥ÑË®≠Ë®à

### 1. Â§ñÈÉ®„Ç≠„ÉºÂà∂Á¥Ñ

```sql
-- ===== FOREIGN KEY CONSTRAINTS =====

-- 1. Âü∫Êú¨ÁöÑ„Å™ÂèÇÁÖßÊï¥ÂêàÊÄß
ALTER TABLE practice_types 
ADD CONSTRAINT fk_practice_types_category 
FOREIGN KEY (category_id) REFERENCES practice_categories(category_id)
ON DELETE RESTRICT ON UPDATE CASCADE;

ALTER TABLE practice_sessions 
ADD CONSTRAINT fk_practice_sessions_user 
FOREIGN KEY (user_id) REFERENCES users(user_id)
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE practice_sessions 
ADD CONSTRAINT fk_practice_sessions_type 
FOREIGN KEY (practice_type_id) REFERENCES practice_types(practice_type_id)
ON DELETE RESTRICT ON UPDATE CASCADE;

-- 2. „Ç´„Çπ„Ç±„Éº„ÉâÂâäÈô§ÂØæÂøú
ALTER TABLE practice_inputs 
ADD CONSTRAINT fk_practice_inputs_session 
FOREIGN KEY (session_id) REFERENCES practice_sessions(session_id)
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE practice_scores 
ADD CONSTRAINT fk_practice_scores_session 
FOREIGN KEY (session_id) REFERENCES practice_sessions(session_id)
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE practice_feedback 
ADD CONSTRAINT fk_practice_feedback_session 
FOREIGN KEY (session_id) REFERENCES practice_sessions(session_id)
ON DELETE CASCADE ON UPDATE CASCADE;

-- 3. Áµ±Ë®à„ÉÜ„Éº„Éñ„É´„ÅÆÂà∂Á¥Ñ
ALTER TABLE user_analytics 
ADD CONSTRAINT fk_user_analytics_user 
FOREIGN KEY (user_id) REFERENCES users(user_id)
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE user_analytics 
ADD CONSTRAINT fk_user_analytics_type 
FOREIGN KEY (practice_type_id) REFERENCES practice_types(practice_type_id)
ON DELETE CASCADE ON UPDATE CASCADE;
```

### 2. „ÉÅ„Çß„ÉÉ„ÇØÂà∂Á¥Ñ

```sql
-- ===== CHECK CONSTRAINTS =====

-- 1. „Çπ„Ç≥„Ç¢ÂÄ§„ÅÆÁØÑÂõ≤Âà∂Á¥Ñ
ALTER TABLE practice_scores 
ADD CONSTRAINT chk_score_value_range 
CHECK (score_value >= 0 AND score_value <= max_score);

ALTER TABLE practice_scores 
ADD CONSTRAINT chk_max_score_positive 
CHECK (max_score > 0);

ALTER TABLE practice_scores 
ADD CONSTRAINT chk_weight_range 
CHECK (weight >= 0 AND weight <= 10);

-- 2. „Çª„ÉÉ„Ç∑„Éß„É≥Áä∂ÊÖã„ÅÆÂà∂Á¥Ñ
ALTER TABLE practice_sessions 
ADD CONSTRAINT chk_session_status 
CHECK (status IN ('in_progress', 'completed', 'abandoned', 'error'));

ALTER TABLE practice_sessions 
ADD CONSTRAINT chk_completion_percentage 
CHECK (completion_percentage >= 0 AND completion_percentage <= 100);

ALTER TABLE practice_sessions 
ADD CONSTRAINT chk_duration_positive 
CHECK (duration_seconds IS NULL OR duration_seconds >= 0);

-- 3. ÊôÇÁ≥ªÂàóÂà∂Á¥Ñ
ALTER TABLE practice_sessions 
ADD CONSTRAINT chk_session_time_order 
CHECK (end_time IS NULL OR end_time >= start_time);

-- 4. „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„Çø„Ç§„ÉóÂà∂Á¥Ñ
ALTER TABLE practice_feedback 
ADD CONSTRAINT chk_feedback_type 
CHECK (feedback_type IN ('general', 'improvement', 'strong_point', 'error'));

-- 5. Èõ£ÊòìÂ∫¶„É¨„Éô„É´Âà∂Á¥Ñ
ALTER TABLE practice_types 
ADD CONSTRAINT chk_difficulty_level 
CHECK (difficulty_level BETWEEN 1 AND 5);

ALTER TABLE practice_themes 
ADD CONSTRAINT chk_theme_difficulty_level 
CHECK (difficulty_level BETWEEN 1 AND 5);

-- 6. ÂÖ•ÂäõÈ†ÜÂ∫èÂà∂Á¥Ñ
ALTER TABLE practice_inputs 
ADD CONSTRAINT chk_input_order_positive 
CHECK (input_order > 0);

-- 7. ÊñáÂ≠óÊï∞Âà∂Á¥Ñ
ALTER TABLE practice_inputs 
ADD CONSTRAINT chk_word_count_positive 
CHECK (word_count IS NULL OR word_count >= 0);

-- 8. „É¶„Éº„Ç∂„Éº„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖãÂà∂Á¥Ñ
ALTER TABLE users 
ADD CONSTRAINT chk_last_active_order 
CHECK (last_active >= created_at);
```

### 3. ‰∏ÄÊÑèÊÄßÂà∂Á¥Ñ

```sql
-- ===== UNIQUE CONSTRAINTS =====

-- 1. Âü∫Êú¨ÁöÑ„Å™‰∏ÄÊÑèÊÄß
ALTER TABLE practice_categories 
ADD CONSTRAINT uk_category_name UNIQUE (category_name);

ALTER TABLE practice_types 
ADD CONSTRAINT uk_type_name UNIQUE (type_name);

ALTER TABLE users 
ADD CONSTRAINT uk_user_email UNIQUE (email);

-- 2. Ë§áÂêà‰∏ÄÊÑèÊÄßÂà∂Á¥Ñ
ALTER TABLE user_analytics 
ADD CONSTRAINT uk_user_analytics_user_type 
UNIQUE (user_id, practice_type_id);

-- 3. Êù°‰ª∂‰ªò„Åç‰∏ÄÊÑèÊÄßÔºàÈÉ®ÂàÜ„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÔºâ
CREATE UNIQUE INDEX uk_active_session_per_user 
ON practice_sessions(user_id, practice_type_id) 
WHERE status = 'in_progress';

-- 4. „ÇΩ„Éº„ÉàÈ†Ü„ÅÆ‰∏ÄÊÑèÊÄß
ALTER TABLE practice_categories 
ADD CONSTRAINT uk_category_sort_order UNIQUE (sort_order);

ALTER TABLE practice_types 
ADD CONSTRAINT uk_type_sort_order_per_category 
UNIQUE (category_id, sort_order);
```

### 4. NOT NULLÂà∂Á¥Ñ„ÅÆÂº∑Âåñ

```sql
-- ===== NOT NULL CONSTRAINTS =====

-- Âü∫Êú¨„Éï„Ç£„Éº„É´„Éâ„ÅÆÂøÖÈ†àÂåñ
ALTER TABLE users ALTER COLUMN created_at SET NOT NULL;
ALTER TABLE users ALTER COLUMN last_active SET NOT NULL;
ALTER TABLE users ALTER COLUMN is_active SET NOT NULL;

ALTER TABLE practice_sessions ALTER COLUMN user_id SET NOT NULL;
ALTER TABLE practice_sessions ALTER COLUMN practice_type_id SET NOT NULL;
ALTER TABLE practice_sessions ALTER COLUMN start_time SET NOT NULL;
ALTER TABLE practice_sessions ALTER COLUMN status SET NOT NULL;

ALTER TABLE practice_inputs ALTER COLUMN session_id SET NOT NULL;
ALTER TABLE practice_inputs ALTER COLUMN input_type SET NOT NULL;

ALTER TABLE practice_scores ALTER COLUMN session_id SET NOT NULL;
ALTER TABLE practice_scores ALTER COLUMN score_category SET NOT NULL;
ALTER TABLE practice_scores ALTER COLUMN score_value SET NOT NULL;
ALTER TABLE practice_scores ALTER COLUMN max_score SET NOT NULL;

ALTER TABLE practice_feedback ALTER COLUMN session_id SET NOT NULL;
ALTER TABLE practice_feedback ALTER COLUMN feedback_content SET NOT NULL;
```

---

## ‚ö° „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©Âåñ

### 1. Áµ±Ë®àÊÉÖÂ†±„ÅÆÊúÄÈÅ©Âåñ

```sql
-- ===== STATISTICS OPTIMIZATION =====

-- 1. „Ç´„Çπ„Çø„É†Áµ±Ë®à„Çø„Éº„Ç≤„ÉÉ„ÉàË®≠ÂÆö
ALTER TABLE practice_sessions ALTER COLUMN user_id SET STATISTICS 1000;
ALTER TABLE practice_sessions ALTER COLUMN practice_type_id SET STATISTICS 1000;
ALTER TABLE practice_sessions ALTER COLUMN created_at SET STATISTICS 1000;

ALTER TABLE practice_scores ALTER COLUMN score_category SET STATISTICS 500;
ALTER TABLE practice_scores ALTER COLUMN score_percentage SET STATISTICS 500;

-- 2. Êã°ÂºµÁµ±Ë®àÔºàÁõ∏Èñ¢ÂàÜÊûêÔºâ
CREATE STATISTICS stats_session_user_type_time 
ON user_id, practice_type_id, created_at 
FROM practice_sessions;

CREATE STATISTICS stats_score_category_value_time 
ON score_category, score_value, created_at 
FROM practice_scores;

-- 3. Áµ±Ë®àÊÉÖÂ†±„ÅÆËá™ÂãïÊõ¥Êñ∞
CREATE OR REPLACE FUNCTION update_table_statistics()
RETURNS void AS $$
BEGIN
    ANALYZE practice_sessions;
    ANALYZE practice_inputs;
    ANALYZE practice_scores;
    ANALYZE practice_feedback;
    ANALYZE user_analytics;
END;
$$ LANGUAGE plpgsql;

-- ÂÆöÊúüÂÆüË°å„ÅÆË®≠ÂÆöÔºàpg_cron„ÅåÂà©Áî®ÂèØËÉΩ„Å™Â†¥ÂêàÔºâ
-- SELECT cron.schedule('update-stats', '0 2 * * *', 'SELECT update_table_statistics();');
```

### 2. „Éë„Éº„ÉÜ„Ç£„Ç∑„Éß„Éã„É≥„Ç∞Êà¶Áï•

```sql
-- ===== PARTITIONING STRATEGY =====

-- 1. Á∑¥Áøí„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆÊúàÊ¨°„Éë„Éº„ÉÜ„Ç£„Ç∑„Éß„Éã„É≥„Ç∞
ALTER TABLE practice_sessions_new RENAME TO practice_sessions_old;

CREATE TABLE practice_sessions (
    session_id UUID NOT NULL DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    practice_type_id INTEGER NOT NULL,
    theme VARCHAR(200),
    start_time TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    end_time TIMESTAMP WITH TIME ZONE,
    duration_seconds INTEGER,
    status VARCHAR(20) NOT NULL DEFAULT 'in_progress',
    completion_percentage DECIMAL(5,2) DEFAULT 0.00,
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    PRIMARY KEY (session_id, created_at)
) PARTITION BY RANGE (created_at);

-- 2. ÊúàÊ¨°„Éë„Éº„ÉÜ„Ç£„Ç∑„Éß„É≥‰ΩúÊàêÈñ¢Êï∞
CREATE OR REPLACE FUNCTION create_monthly_partitions(
    start_date DATE,
    end_date DATE
)
RETURNS void AS $$
DECLARE
    current_date DATE := start_date;
    partition_name TEXT;
    next_month DATE;
BEGIN
    WHILE current_date < end_date LOOP
        partition_name := 'practice_sessions_' || to_char(current_date, 'YYYY_MM');
        next_month := current_date + INTERVAL '1 month';
        
        EXECUTE format('
            CREATE TABLE %I PARTITION OF practice_sessions
            FOR VALUES FROM (%L) TO (%L)',
            partition_name, current_date, next_month);
            
        -- „Éë„Éº„ÉÜ„Ç£„Ç∑„Éß„É≥Áî®„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰ΩúÊàê
        EXECUTE format('
            CREATE INDEX %I ON %I (user_id, practice_type_id, created_at DESC)',
            'idx_' || partition_name || '_user_type_date', partition_name);
            
        current_date := next_month;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- 3. Ëá™Âãï„Éë„Éº„ÉÜ„Ç£„Ç∑„Éß„É≥‰ΩúÊàê
SELECT create_monthly_partitions('2024-01-01'::DATE, '2025-01-01'::DATE);

-- 4. Âè§„ÅÑ„Éë„Éº„ÉÜ„Ç£„Ç∑„Éß„É≥„ÅÆËá™ÂãïÂâäÈô§Ôºà1Âπ¥ÂæåÔºâ
CREATE OR REPLACE FUNCTION cleanup_old_partitions()
RETURNS void AS $$
DECLARE
    partition_name TEXT;
    cutoff_date DATE := CURRENT_DATE - INTERVAL '12 months';
BEGIN
    FOR partition_name IN
        SELECT tablename 
        FROM pg_tables 
        WHERE tablename LIKE 'practice_sessions_%'
        AND tablename < 'practice_sessions_' || to_char(cutoff_date, 'YYYY_MM')
    LOOP
        EXECUTE 'DROP TABLE ' || partition_name || ' CASCADE';
        RAISE NOTICE 'Dropped old partition: %', partition_name;
    END LOOP;
END;
$$ LANGUAGE plpgsql;
```

### 3. „ÇØ„Ç®„É™ÊúÄÈÅ©Âåñ„ÅÆ„Åü„ÇÅ„ÅÆ„Éì„É•„Éº

```sql
-- ===== OPTIMIZED VIEWS =====

-- 1. „É¶„Éº„Ç∂„ÉºÂ±•Ê≠¥„Çµ„Éû„É™„Éº„Éì„É•„Éº
CREATE MATERIALIZED VIEW mv_user_practice_summary AS
SELECT 
    ps.user_id,
    ps.practice_type_id,
    pt.display_name as practice_type_name,
    pc.display_name as category_name,
    COUNT(*) as total_sessions,
    AVG(ps.duration_seconds) as avg_duration,
    AVG(scores.avg_score) as avg_score,
    MAX(ps.created_at) as last_practice_date,
    COUNT(*) FILTER (WHERE ps.created_at > CURRENT_DATE - INTERVAL '7 days') as sessions_last_week,
    COUNT(*) FILTER (WHERE ps.created_at > CURRENT_DATE - INTERVAL '30 days') as sessions_last_month
FROM practice_sessions ps
JOIN practice_types pt ON ps.practice_type_id = pt.practice_type_id
JOIN practice_categories pc ON pt.category_id = pc.category_id
LEFT JOIN (
    SELECT session_id, AVG(score_percentage) as avg_score
    FROM practice_scores
    GROUP BY session_id
) scores ON ps.session_id = scores.session_id
WHERE ps.status = 'completed'
GROUP BY ps.user_id, ps.practice_type_id, pt.display_name, pc.display_name;

CREATE UNIQUE INDEX idx_mv_user_practice_summary 
ON mv_user_practice_summary(user_id, practice_type_id);

-- 2. „Çπ„Ç≥„Ç¢Áµ±Ë®à„Éì„É•„Éº
CREATE MATERIALIZED VIEW mv_score_statistics AS
SELECT 
    score_category,
    practice_type_id,
    COUNT(*) as total_scores,
    AVG(score_percentage) as avg_score,
    STDDEV(score_percentage) as score_stddev,
    PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY score_percentage) as q1_score,
    PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY score_percentage) as median_score,
    PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY score_percentage) as q3_score,
    MIN(score_percentage) as min_score,
    MAX(score_percentage) as max_score
FROM practice_scores ps
JOIN practice_sessions sess ON ps.session_id = sess.session_id
WHERE sess.status = 'completed'
GROUP BY score_category, practice_type_id;

-- 3. „Éû„ÉÜ„É™„Ç¢„É©„Ç§„Ç∫„Éâ„Éì„É•„Éº„ÅÆËá™ÂãïÊõ¥Êñ∞
CREATE OR REPLACE FUNCTION refresh_materialized_views()
RETURNS void AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY mv_user_practice_summary;
    REFRESH MATERIALIZED VIEW CONCURRENTLY mv_score_statistics;
END;
$$ LANGUAGE plpgsql;
```

---

## üìä Áõ£Ë¶ñ„Éª„É°„É≥„ÉÜ„Éä„É≥„Çπ

### 1. „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÁõ£Ë¶ñ

```sql
-- ===== PERFORMANCE MONITORING =====

-- 1. „Çπ„É≠„Éº„ÇØ„Ç®„É™Áõ£Ë¶ñ„Éì„É•„Éº
CREATE VIEW v_slow_queries AS
SELECT 
    query,
    calls,
    total_time,
    mean_time,
    rows,
    100.0 * shared_blks_hit / nullif(shared_blks_hit + shared_blks_read, 0) AS hit_percent
FROM pg_stat_statements 
WHERE mean_time > 100  -- 100ms‰ª•‰∏ä
ORDER BY mean_time DESC;

-- 2. „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰ΩøÁî®Áä∂Ê≥ÅÁõ£Ë¶ñ
CREATE VIEW v_index_usage AS
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch,
    pg_size_pretty(pg_relation_size(indexrelid)) as index_size
FROM pg_stat_user_indexes 
ORDER BY idx_scan DESC;

-- 3. „ÉÜ„Éº„Éñ„É´„Çµ„Ç§„Ç∫Áõ£Ë¶ñ
CREATE VIEW v_table_sizes AS
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) as table_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) - pg_relation_size(schemaname||'.'||tablename)) as index_size
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- 4. Êé•Á∂ö„Éª„É≠„ÉÉ„ÇØÁõ£Ë¶ñ
CREATE VIEW v_active_connections AS
SELECT 
    pid,
    usename,
    application_name,
    client_addr,
    state,
    query_start,
    state_change,
    query
FROM pg_stat_activity 
WHERE state != 'idle'
ORDER BY query_start;
```

### 2. Ëá™Âãï„É°„É≥„ÉÜ„Éä„É≥„Çπ„Çø„Çπ„ÇØ

```sql
-- ===== MAINTENANCE TASKS =====

-- 1. „Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÂÜçÊßãÁØâÈñ¢Êï∞
CREATE OR REPLACE FUNCTION rebuild_fragmented_indexes(
    fragmentation_threshold REAL DEFAULT 20.0
)
RETURNS void AS $$
DECLARE
    index_rec RECORD;
BEGIN
    -- Êñ≠ÁâáÂåñ„Åó„Åü„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÊ§úÂá∫„Åó„Å¶ÂÜçÊßãÁØâ
    FOR index_rec IN
        SELECT 
            schemaname, 
            tablename, 
            indexname,
            pg_stat_user_indexes.idx_scan,
            pg_relation_size(indexrelid) as index_size
        FROM pg_stat_user_indexes
        WHERE schemaname = 'public'
        AND pg_relation_size(indexrelid) > 10 * 1024 * 1024  -- 10MB‰ª•‰∏ä
    LOOP
        -- ÂÆüÈöõ„ÅÆÊñ≠ÁâáÂåñ„ÉÅ„Çß„ÉÉ„ÇØ„ÅØÁúÅÁï•Ôºàpg_stat_user_indexes„Åß„ÅØÊ≠£Á¢∫„Å™Ê∏¨ÂÆö„ÅåÂõ∞Èõ£Ôºâ
        -- Êú¨Áï™Áí∞Â¢É„Åß„ÅØ„ÄÅpg_stat_user_indexes„ÇÑpgstattuple„Çí‰ΩøÁî®
        
        EXECUTE 'REINDEX INDEX CONCURRENTLY ' || quote_ident(index_rec.indexname);
        RAISE NOTICE 'Rebuilt index: %', index_rec.indexname;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- 2. Áµ±Ë®àÊÉÖÂ†±Êõ¥Êñ∞„Å®VACUUM
CREATE OR REPLACE FUNCTION maintenance_routine()
RETURNS void AS $$
BEGIN
    -- 1. Áµ±Ë®àÊÉÖÂ†±Êõ¥Êñ∞
    ANALYZE;
    
    -- 2. „Éû„ÉÜ„É™„Ç¢„É©„Ç§„Ç∫„Éâ„Éì„É•„ÉºÊõ¥Êñ∞
    PERFORM refresh_materialized_views();
    
    -- 3. Âè§„ÅÑ„Éë„Éº„ÉÜ„Ç£„Ç∑„Éß„É≥ÂâäÈô§
    PERFORM cleanup_old_partitions();
    
    -- 4. „É¶„Éº„Ç∂„ÉºÂàÜÊûê„Éá„Éº„ÇøÊõ¥Êñ∞
    INSERT INTO user_analytics (user_id, practice_type_id, total_sessions, average_score, latest_session_date)
    SELECT 
        ps.user_id,
        ps.practice_type_id,
        COUNT(*) as total_sessions,
        AVG(scores.avg_score) as average_score,
        MAX(ps.created_at) as latest_session_date
    FROM practice_sessions ps
    LEFT JOIN (
        SELECT session_id, AVG(score_percentage) as avg_score
        FROM practice_scores 
        GROUP BY session_id
    ) scores ON ps.session_id = scores.session_id
    WHERE ps.status = 'completed'
    AND ps.created_at > CURRENT_DATE - INTERVAL '7 days'  -- ÈÅéÂéª1ÈÄ±ÈñìÂàÜ„ÅÆ„ÅøÊõ¥Êñ∞
    GROUP BY ps.user_id, ps.practice_type_id
    ON CONFLICT (user_id, practice_type_id) 
    DO UPDATE SET
        total_sessions = user_analytics.total_sessions + EXCLUDED.total_sessions,
        average_score = (user_analytics.average_score + EXCLUDED.average_score) / 2,
        latest_session_date = GREATEST(user_analytics.latest_session_date, EXCLUDED.latest_session_date),
        last_updated = NOW();
    
    RAISE NOTICE 'Maintenance routine completed at %', NOW();
END;
$$ LANGUAGE plpgsql;
```

### 3. „Ç¢„É©„Éº„Éà„ÉªÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†

```sql
-- ===== ALERTING SYSTEM =====

-- 1. „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÂä£ÂåñÊ§úÁü•
CREATE OR REPLACE FUNCTION check_performance_degradation()
RETURNS void AS $$
DECLARE
    slow_query_count INTEGER;
    avg_response_time REAL;
BEGIN
    -- „Çπ„É≠„Éº„ÇØ„Ç®„É™Êï∞„Çí„ÉÅ„Çß„ÉÉ„ÇØ
    SELECT COUNT(*) INTO slow_query_count
    FROM pg_stat_statements 
    WHERE mean_time > 500;  -- 500ms‰ª•‰∏ä
    
    IF slow_query_count > 10 THEN
        RAISE WARNING 'Performance Alert: % slow queries detected', slow_query_count;
    END IF;
    
    -- Âπ≥Âùá„É¨„Çπ„Éù„É≥„ÇπÊôÇÈñì„Çí„ÉÅ„Çß„ÉÉ„ÇØ
    SELECT AVG(mean_time) INTO avg_response_time
    FROM pg_stat_statements;
    
    IF avg_response_time > 200 THEN
        RAISE WARNING 'Performance Alert: Average response time is %.2f ms', avg_response_time;
    END IF;
END;
$$ LANGUAGE plpgsql;

-- 2. „Éá„Ç£„Çπ„ÇØÂÆπÈáèÁõ£Ë¶ñ
CREATE OR REPLACE FUNCTION check_disk_usage()
RETURNS void AS $$
DECLARE
    total_size BIGINT;
    size_gb REAL;
BEGIN
    SELECT SUM(pg_total_relation_size(oid)) INTO total_size
    FROM pg_class 
    WHERE relkind IN ('r', 'i');  -- „ÉÜ„Éº„Éñ„É´„Å®„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
    
    size_gb := total_size / (1024.0 * 1024.0 * 1024.0);
    
    IF size_gb > 5.0 THEN  -- 5GB‰ª•‰∏ä„ÅÆÂ†¥Âêà
        RAISE WARNING 'Disk Usage Alert: Database size is %.2f GB', size_gb;
    END IF;
END;
$$ LANGUAGE plpgsql;
```

### 4. ÂÆöÊúüÂÆüË°åË®≠ÂÆö

```sql
-- ===== SCHEDULED JOBS =====

-- pg_cron„ÅåÂà©Áî®ÂèØËÉΩ„Å™Â†¥Âêà„ÅÆË®≠ÂÆö‰æã
-- ÔºàSupabase„Åß„ÅØÂà©Áî®„Åß„Åç„Å™„ÅÑÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„Åü„ÇÅ„ÄÅ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂÅ¥„ÅßÂÆüË£ÖÔºâ

/*
-- ÊØéÊó•Ê∑±Â§ú2ÊôÇ„Å´Áµ±Ë®àÊÉÖÂ†±Êõ¥Êñ∞
SELECT cron.schedule('daily-maintenance', '0 2 * * *', 'SELECT maintenance_routine();');

-- ÊØéÊôÇ„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÉÅ„Çß„ÉÉ„ÇØ
SELECT cron.schedule('hourly-performance-check', '0 * * * *', 'SELECT check_performance_degradation();');

-- ÊØéÊó•„Éá„Ç£„Çπ„ÇØ‰ΩøÁî®Èáè„ÉÅ„Çß„ÉÉ„ÇØ
SELECT cron.schedule('daily-disk-check', '30 2 * * *', 'SELECT check_disk_usage();');

-- ÈÄ±Ê¨°„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÂÜçÊßãÁØâÔºàÊó•ÊõúÊ∑±Â§úÔºâ
SELECT cron.schedule('weekly-reindex', '0 3 * * 0', 'SELECT rebuild_fragmented_indexes();');
*/
```

---

## üìã ÂÆüË£Ö„ÉÅ„Çß„ÉÉ„ÇØ„É™„Çπ„Éà

### „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰ΩúÊàê
- [ ] ‰∏ªË¶Å„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰ΩúÊàê
- [ ] Ë§áÂêà„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰ΩúÊàê
- [ ] „Éï„É´„ÉÜ„Ç≠„Çπ„ÉàÊ§úÁ¥¢„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰ΩúÊàê
- [ ] „Éë„Éº„ÉÜ„Ç£„Ç∑„Éß„É≥ÂØæÂøú„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰ΩúÊàê

### Âà∂Á¥ÑË®≠ÂÆö
- [ ] Â§ñÈÉ®„Ç≠„ÉºÂà∂Á¥ÑËøΩÂä†
- [ ] „ÉÅ„Çß„ÉÉ„ÇØÂà∂Á¥ÑËøΩÂä†
- [ ] ‰∏ÄÊÑèÊÄßÂà∂Á¥ÑËøΩÂä†
- [ ] NOT NULLÂà∂Á¥ÑÂº∑Âåñ

### ÊúÄÈÅ©Âåñ
- [ ] Áµ±Ë®àÊÉÖÂ†±Ë®≠ÂÆö
- [ ] „Éë„Éº„ÉÜ„Ç£„Ç∑„Éß„Éã„É≥„Ç∞ÂÆüË£Ö
- [ ] „Éû„ÉÜ„É™„Ç¢„É©„Ç§„Ç∫„Éâ„Éì„É•„Éº‰ΩúÊàê
- [ ] ÊúÄÈÅ©ÂåñÈñ¢Êï∞ÂÆüË£Ö

### Áõ£Ë¶ñ„Éª„É°„É≥„ÉÜ„Éä„É≥„Çπ
- [ ] Áõ£Ë¶ñ„Éì„É•„Éº‰ΩúÊàê
- [ ] „É°„É≥„ÉÜ„Éä„É≥„ÇπÈñ¢Êï∞ÂÆüË£Ö
- [ ] „Ç¢„É©„Éº„ÉàÈñ¢Êï∞ÂÆüË£Ö
- [ ] ÂÆöÊúüÂÆüË°åË®≠ÂÆöÔºà„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂÅ¥Ôºâ

---

## üéØ ÊúüÂæÖ„Åï„Çå„Çã„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊîπÂñÑ

### „Éô„É≥„ÉÅ„Éû„Éº„ÇØÁõÆÊ®ô
- **„ÇØ„Ç®„É™„É¨„Çπ„Éù„É≥„ÇπÊôÇÈñì**: 50%‰ª•‰∏äÁü≠Á∏Æ
- **ÂêåÊôÇÊé•Á∂öÂá¶ÁêÜËÉΩÂäõ**: 3ÂÄçÂêë‰∏ä
- **„Éá„Ç£„Çπ„ÇØ I/O**: 30%ÂâäÊ∏õ
- **„É°„É¢„É™‰ΩøÁî®ÂäπÁéá**: 40%Âêë‰∏ä

### ÂÖ∑‰ΩìÁöÑ„Å™ÊîπÂñÑ‰æã
```sql
-- ÊîπÂñÑÂâçÔºàÊó¢Â≠ò„ÅÆJSONB„ÇØ„Ç®„É™Ôºâ
SELECT * FROM practice_history 
WHERE session_id = 'user-123' 
AND inputs->>'theme' = 'ÂøÉÁ≠ãÊ¢óÂ°û'
ORDER BY practice_date DESC;
-- ÂÆüË°åÊôÇÈñì: ~200ms

-- ÊîπÂñÑÂæåÔºàÊ≠£Ë¶èÂåñ„Åï„Çå„Åü„ÉÜ„Éº„Éñ„É´Ôºâ
SELECT ps.*, pi.content as theme_content
FROM practice_sessions ps
JOIN practice_inputs pi ON ps.session_id = pi.session_id
WHERE ps.user_id = 'user-123'::uuid
AND ps.theme = 'ÂøÉÁ≠ãÊ¢óÂ°û'
AND pi.input_type = 'theme'
ORDER BY ps.created_at DESC;
-- ÂÆüË°åÊôÇÈñì: ~50ms (75%ÊîπÂñÑ)
``` 