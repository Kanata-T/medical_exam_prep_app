import streamlit as st
import google.genai as genai
from modules.utils import safe_api_call

def validate_exam_inputs(abstract, translation, opinion, essay, essay_theme):
    """
    æ¡ç‚¹å¯¾è±¡ã®å…¥åŠ›å€¤ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚
    
    Args:
        abstract (str): åŸæ–‡Abstract
        translation (str): æ—¥æœ¬èªè¨³
        opinion (str): æ„è¦‹
        essay (str): å°è«–æ–‡
        essay_theme (str): å°è«–æ–‡ãƒ†ãƒ¼ãƒ
    
    Returns:
        tuple: (bool, str) - (æœ‰åŠ¹?, ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸)
    """
    if not abstract or len(abstract.strip()) < 50:
        return False, "AbstractãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚"
    
    if not translation or len(translation.strip()) < 30:
        return False, "æ—¥æœ¬èªè¨³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæœ€ä½30æ–‡å­—ï¼‰ã€‚"
    
    if not opinion or len(opinion.strip()) < 50:
        return False, "æ„è¦‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæœ€ä½50æ–‡å­—ï¼‰ã€‚"
    
    if not essay or len(essay.strip()) < 100:
        return False, "å°è«–æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæœ€ä½100æ–‡å­—ï¼‰ã€‚"
    
    if not essay_theme or len(essay_theme.strip()) < 10:
        return False, "å°è«–æ–‡ãƒ†ãƒ¼ãƒãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
    
    return True, ""

def get_scoring_prompt(abstract, translation, opinion, essay, essay_theme):
    """
    æ¡ç‚¹ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚
    
    Returns:
        str: æ¡ç‚¹ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    """
    return f"""ã‚ãªãŸã¯åŒ»å­¦éƒ¨ç ”ä¿®åŒ»æ¡ç”¨è©¦é¨“ã®çµŒé¨“è±Šå¯Œãªæ¡ç‚¹è€…ã§ã™ã€‚ä»¥ä¸‹ã®ç­”æ¡ˆã‚’å³æ­£ã‹ã¤å…¬å¹³ã«æ¡ç‚¹ã—ã¦ãã ã•ã„ã€‚è©•ä¾¡ã¯å‡ºåŠ›åˆ¶é™ã‚’æ°—ã«ã›ãšç´°ã‹ãå¯èƒ½ãªé™ã‚Šæ›¸ã„ã¦ãã ã•ã„ã€‚

ã€åŸæ–‡Abstractã€‘
{abstract}

ã€å—é¨“è€…ã®å›ç­”ã€‘
â–  èª²é¡Œ1: Abstractã®æ—¥æœ¬èªè¨³
{translation}

â–  èª²é¡Œ2: Abstractã«å¯¾ã™ã‚‹æ„è¦‹
{opinion}

â–  èª²é¡Œ3: å°è«–æ–‡ã€Œ{essay_theme}ã€
{essay}

ã€æ¡ç‚¹åŸºæº–ã€‘
å„é …ç›®ã‚’10ç‚¹æº€ç‚¹ã§è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚

1. **æ—¥æœ¬èªè¨³ (10ç‚¹æº€ç‚¹)**
   - æ­£ç¢ºæ€§ (4ç‚¹): å°‚é–€ç”¨èªã‚„æ–‡è„ˆã®ç†è§£åº¦
   - æµæš¢æ€§ (3ç‚¹): è‡ªç„¶ã§èª­ã¿ã‚„ã™ã„æ—¥æœ¬èª
   - å®Œæˆåº¦ (3ç‚¹): å…¨ä½“çš„ãªã¾ã¨ã¾ã‚Šã¨è¨³ã—æ¼ã‚Œã®æœ‰ç„¡

2. **æ„è¦‹ (10ç‚¹æº€ç‚¹)**
   - ç†è§£åº¦ (3ç‚¹): Abstractã®å†…å®¹ã‚’æ­£ç¢ºã«æŠŠæ¡
   - è«–ç†æ€§ (4ç‚¹): ç­‹é“ç«‹ã£ãŸè­°è«–ã®å±•é–‹
   - ç‹¬å‰µæ€§ (3ç‚¹): ç‹¬è‡ªã®è¦–ç‚¹ã‚„æ·±ã„æ´å¯Ÿ

3. **å°è«–æ–‡ (10ç‚¹æº€ç‚¹)**
   - æ§‹æˆåŠ› (4ç‚¹): åºè«–ãƒ»æœ¬è«–ãƒ»çµè«–ã®æ˜ç¢ºæ€§
   - å†…å®¹ã®å……å®Ÿåº¦ (4ç‚¹): å…·ä½“ä¾‹ã‚„æ ¹æ‹ ã®æç¤º
   - æ–‡ç« æŠ€è¡“ (2ç‚¹): è¡¨ç¾åŠ›ã¨æ–‡æ³•ã®æ­£ç¢ºæ€§

ã€å‡ºåŠ›å½¢å¼ã€‘
å¿…ãšä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

**ã‚¹ã‚³ã‚¢:**
```json
{{
  "æ—¥æœ¬èªè¨³": [1-10ã®æ•´æ•°],
  "æ„è¦‹": [1-10ã®æ•´æ•°],
  "å°è«–æ–‡": [1-10ã®æ•´æ•°]
}}
```

## ç·åˆè©•ä¾¡
[30ç‚¹æº€ç‚¹ä¸­ã®å¾—ç‚¹ã¨å…¨ä½“çš„ãªã‚³ãƒ¡ãƒ³ãƒˆ]

## èª²é¡Œ1: æ—¥æœ¬èªè¨³ã®è©•ä¾¡
**è‰¯ã„ç‚¹:**
- [å…·ä½“çš„ãªè‰¯ã„ç‚¹ã‚’è¨˜è¿°ã€‚ã©ã®è¡¨ç¾ã‚„è‰¯ã‹ã£ãŸã‹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚]

**æ”¹å–„ç‚¹:**
- [å…·ä½“çš„ãªæ”¹å–„ç‚¹ã‚’è¨˜è¿°ã€‚ã©ã®è¡¨ç¾ãŒæ”¹å–„ã™ã¹ãã‹ã€‚ã¾ãŸã€æ”¹å–„ã™ã‚‹ã¨ã—ãŸã‚‰ã©ã®ã‚ˆã†ã«ã™ã¹ãã‹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚]

## èª²é¡Œ2: æ„è¦‹ã®è©•ä¾¡
**è‰¯ã„ç‚¹:**
- [å…·ä½“çš„ãªè‰¯ã„ç‚¹ã‚’è¨˜è¿°ã€‚ã©ã®è¡¨ç¾ã‚„è‰¯ã‹ã£ãŸã‹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚]

**æ”¹å–„ç‚¹:**
- [å…·ä½“çš„ãªæ”¹å–„ç‚¹ã‚’è¨˜è¿°ã€‚ã©ã®è¡¨ç¾ãŒæ”¹å–„ã™ã¹ãã‹ã€‚ã¾ãŸã€æ”¹å–„ã™ã‚‹ã¨ã—ãŸã‚‰ã©ã®ã‚ˆã†ã«ã™ã¹ãã‹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚è«–ç†æ€§ã‚„æ§‹æˆã€å†…å®¹ã®å……å®Ÿåº¦ãªã©ã«ã¤ã„ã¦ã‚‚è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚
]

## èª²é¡Œ3: å°è«–æ–‡ã®è©•ä¾¡
**è‰¯ã„ç‚¹:**
- [å…·ä½“çš„ãªè‰¯ã„ç‚¹ã‚’è¨˜è¿°ã€‚ã©ã®è¡¨ç¾ã‚„è‰¯ã‹ã£ãŸã‹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚]

**æ”¹å–„ç‚¹:**
- [å…·ä½“çš„ãªæ”¹å–„ç‚¹ã‚’è¨˜è¿°ã€‚ã©ã®è¡¨ç¾ãŒæ”¹å–„ã™ã¹ãã‹ã€‚ã¾ãŸã€æ”¹å–„ã™ã‚‹ã¨ã—ãŸã‚‰ã©ã®ã‚ˆã†ã«ã™ã¹ãã‹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚è«–ç†æ€§ã‚„æ§‹æˆã€å†…å®¹ã®å……å®Ÿåº¦ãªã©ã«ã¤ã„ã¦ã‚‚è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚]

## å­¦ç¿’ã‚¢ãƒ‰ãƒã‚¤ã‚¹
[ä»Šå¾Œã®å­¦ç¿’ã«å‘ã‘ãŸå…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹]
"""

class ScoringError(Exception):
    """æ¡ç‚¹å‡¦ç†å°‚ç”¨ã®ä¾‹å¤–ã‚¯ãƒ©ã‚¹"""
    pass

def score_exam_stream(abstract, translation, opinion, essay, essay_theme):
    """
    æ¡ç”¨è©¦é¨“ã®æå‡ºç‰©ã‚’æ¡ç‚¹ã—ã€çµæœã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§è¿”ã™ã€‚
    
    Args:
        abstract (str): åŸæ–‡Abstract
        translation (str): æ—¥æœ¬èªè¨³
        opinion (str): æ„è¦‹  
        essay (str): å°è«–æ–‡
        essay_theme (str): å°è«–æ–‡ãƒ†ãƒ¼ãƒ
    
    Yields:
        æ¡ç‚¹çµæœã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒãƒ£ãƒ³ã‚¯
    """
    # å…¥åŠ›æ¤œè¨¼
    is_valid, error_msg = validate_exam_inputs(abstract, translation, opinion, essay, essay_theme)
    if not is_valid:
        yield type('ErrorChunk', (), {'text': f"âŒ å…¥åŠ›ã‚¨ãƒ©ãƒ¼: {error_msg}"})()
        return
    
    try:
        client = genai.Client()
        prompt = get_scoring_prompt(abstract, translation, opinion, essay, essay_theme)
        
        # ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¿œç­”ã‚’ç”Ÿæˆ
        response_stream = client.models.generate_content_stream(
            model='gemini-2.5-pro',
            contents=prompt
        )
        
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
        if not response_stream:
            raise ScoringError("AIæ¡ç‚¹ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰å¿œç­”ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚")
        
        chunk_count = 0
        for chunk in response_stream:
            chunk_count += 1
            if hasattr(chunk, 'text') and chunk.text:
                yield chunk
            else:
                # ç„¡åŠ¹ãªãƒãƒ£ãƒ³ã‚¯ã®å ´åˆã¯è­¦å‘Šã‚’è¡¨ç¤º
                yield type('WarningChunk', (), {
                    'text': f"\nâš ï¸ [ãƒãƒ£ãƒ³ã‚¯{chunk_count}] å¿œç­”å½¢å¼ãŒäºˆæœŸã—ãªã„å½¢å¼ã§ã™ã€‚\n"
                })()
        
        # ãƒãƒ£ãƒ³ã‚¯ãŒå…¨ãå—ä¿¡ã•ã‚Œãªã‹ã£ãŸå ´åˆ
        if chunk_count == 0:
            raise ScoringError("æ¡ç‚¹çµæœã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚")
            
    except ScoringError as e:
        yield type('ErrorChunk', (), {'text': f"âŒ æ¡ç‚¹ã‚¨ãƒ©ãƒ¼: {str(e)}"})()
    except Exception as e:
        # äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
        error_msg = f"âŒ ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"
        if "quota" in str(e).lower():
            error_msg += "\n\nğŸ’¡ APIä½¿ç”¨é‡ã®ä¸Šé™ã«é”ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚"
        elif "authentication" in str(e).lower():
            error_msg += "\n\nğŸ’¡ APIèªè¨¼ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚APIã‚­ãƒ¼ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
        
        yield type('ErrorChunk', (), {'text': error_msg})()

def get_score_distribution():
    """
    æ¡ç‚¹åŸºæº–ã®è©³ç´°èª¬æ˜ã‚’è¿”ã—ã¾ã™ã€‚
    
    Returns:
        dict: æ¡ç‚¹åŸºæº–ã®è©³ç´°
    """
    return {
        "æ—¥æœ¬èªè¨³": {
            "9-10ç‚¹": "å°‚é–€ç”¨èªã‚‚å«ã‚ã¦æ­£ç¢ºã«è¨³ã•ã‚Œã€è‡ªç„¶ã§æµæš¢ãªæ—¥æœ¬èª",
            "7-8ç‚¹": "æ¦‚ã­æ­£ç¢ºã§èª­ã¿ã‚„ã™ã„ãŒã€ä¸€éƒ¨ã«ä¸è‡ªç„¶ãªè¡¨ç¾ãŒã‚ã‚‹",
            "5-6ç‚¹": "åŸºæœ¬çš„ãªæ„å‘³ã¯ä¼ã‚ã‚‹ãŒã€èª¤è¨³ã‚„ä¸é©åˆ‡ãªè¡¨ç¾ãŒæ•£è¦‹ã•ã‚Œã‚‹",
            "3-4ç‚¹": "éƒ¨åˆ†çš„ã«æ­£ç¢ºã ãŒã€é‡è¦ãªèª¤è¨³ã‚„è„±è½ãŒã‚ã‚‹",
            "1-2ç‚¹": "å¤§éƒ¨åˆ†ãŒä¸æ­£ç¢ºã¾ãŸã¯ç†è§£å›°é›£"
        },
        "æ„è¦‹": {
            "9-10ç‚¹": "æ·±ã„æ´å¯Ÿã¨ç‹¬å‰µæ€§ãŒã‚ã‚Šã€è«–ç†çš„ã§èª¬å¾—åŠ›ã®ã‚ã‚‹è«–è¿°",
            "7-8ç‚¹": "é©åˆ‡ãªç†è§£ã«åŸºã¥ãå¦¥å½“ãªæ„è¦‹ã§ã€è«–ç†æ€§ã‚‚ã‚ã‚‹",
            "5-6ç‚¹": "åŸºæœ¬çš„ãªç†è§£ã¯ã‚ã‚‹ãŒã€è«–ç†æ€§ã‚„ç‹¬å‰µæ€§ã«æ¬ ã‘ã‚‹",
            "3-4ç‚¹": "éƒ¨åˆ†çš„ç†è§£ã«åŸºã¥ãæµ…ã„æ„è¦‹",
            "1-2ç‚¹": "ç†è§£ä¸è¶³ã§è«–ç†æ€§ã«æ¬ ã‘ã‚‹"
        },
        "å°è«–æ–‡": {
            "9-10ç‚¹": "æ˜ç¢ºãªæ§‹æˆã§å…·ä½“çš„æ ¹æ‹ ã‚‚ã‚ã‚Šã€å„ªã‚ŒãŸæ–‡ç« æŠ€è¡“",
            "7-8ç‚¹": "é©åˆ‡ãªæ§‹æˆã¨å†…å®¹ã§ã€æ–‡ç« æŠ€è¡“ã‚‚æ¦‚ã­è‰¯å¥½",
            "5-6ç‚¹": "åŸºæœ¬çš„ãªæ§‹æˆã¯ã‚ã‚‹ãŒã€å†…å®¹ã®å……å®Ÿåº¦ã‚„æ–‡ç« æŠ€è¡“ã«èª²é¡Œ",
            "3-4ç‚¹": "æ§‹æˆã‚„å†…å®¹ã«æ˜ç¢ºãªä¸å‚™ãŒã‚ã‚‹", 
            "1-2ç‚¹": "æ§‹æˆãŒä¸æ˜ç¢ºã§å†…å®¹ã‚‚ä¸ååˆ†"
        }
    }

def validate_reading_inputs(abstract, translation, opinion):
    """
    è‹±èªèª­è§£ï¼ˆç¿»è¨³+è€ƒå¯Ÿï¼‰ã®å…¥åŠ›å€¤ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚
    
    Args:
        abstract (str): åŸæ–‡Abstract
        translation (str): æ—¥æœ¬èªè¨³
        opinion (str): æ„è¦‹ãƒ»è€ƒå¯Ÿ
    
    Returns:
        tuple: (bool, str) - (æœ‰åŠ¹?, ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸)
    """
    if not abstract or len(abstract.strip()) < 50:
        return False, "AbstractãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚"
    
    if not translation or len(translation.strip()) < 30:
        return False, "æ—¥æœ¬èªè¨³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæœ€ä½30æ–‡å­—ï¼‰ã€‚"
    
    if not opinion or len(opinion.strip()) < 50:
        return False, "æ„è¦‹ãƒ»è€ƒå¯Ÿã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæœ€ä½50æ–‡å­—ï¼‰ã€‚"
    
    return True, ""

def get_reading_scoring_prompt(abstract, translation, opinion):
    """
    è‹±èªèª­è§£ï¼ˆç¿»è¨³+è€ƒå¯Ÿï¼‰ç”¨ã®æ¡ç‚¹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚
    
    Returns:
        str: æ¡ç‚¹ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    """
    return f"""ã‚ãªãŸã¯åŒ»å­¦è‹±èªèª­è§£ã®çµŒé¨“è±Šå¯Œãªæ¡ç‚¹è€…ã§ã™ã€‚ä»¥ä¸‹ã®ç­”æ¡ˆã‚’å³æ­£ã‹ã¤å…¬å¹³ã«æ¡ç‚¹ã—ã¦ãã ã•ã„ã€‚è©•ä¾¡ã¯å‡ºåŠ›åˆ¶é™ã‚’æ°—ã«ã›ãšç´°ã‹ãå¯èƒ½ãªé™ã‚Šæ›¸ã„ã¦ãã ã•ã„ã€‚

ã€åŸæ–‡Abstractã€‘
{abstract}

ã€å—é¨“è€…ã®å›ç­”ã€‘
â–  èª²é¡Œ1: Abstractã®æ—¥æœ¬èªè¨³
{translation}

â–  èª²é¡Œ2: Abstractã«å¯¾ã™ã‚‹æ„è¦‹ãƒ»è€ƒå¯Ÿ
{opinion}

ã€æ¡ç‚¹åŸºæº–ã€‘
å„é …ç›®ã‚’10ç‚¹æº€ç‚¹ã§è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚

1. **æ—¥æœ¬èªè¨³ (10ç‚¹æº€ç‚¹)**
   - æ­£ç¢ºæ€§ (4ç‚¹): å°‚é–€ç”¨èªã‚„æ–‡è„ˆã®ç†è§£åº¦
   - æµæš¢æ€§ (3ç‚¹): è‡ªç„¶ã§èª­ã¿ã‚„ã™ã„æ—¥æœ¬èª
   - å®Œæˆåº¦ (3ç‚¹): å…¨ä½“çš„ãªã¾ã¨ã¾ã‚Šã¨è¨³ã—æ¼ã‚Œã®æœ‰ç„¡

2. **æ„è¦‹ãƒ»è€ƒå¯Ÿ (10ç‚¹æº€ç‚¹)**
   - ç†è§£åº¦ (4ç‚¹): Abstractã®å†…å®¹ã‚’æ­£ç¢ºã«æŠŠæ¡
   - è«–ç†æ€§ (4ç‚¹): ç­‹é“ç«‹ã£ãŸè­°è«–ã®å±•é–‹
   - ç‹¬å‰µæ€§ (2ç‚¹): ç‹¬è‡ªã®è¦–ç‚¹ã‚„æ·±ã„æ´å¯Ÿ

ã€å‡ºåŠ›å½¢å¼ã€‘
å¿…ãšä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

**ã‚¹ã‚³ã‚¢:**
```json
{{
  "æ—¥æœ¬èªè¨³": [1-10ã®æ•´æ•°],
  "æ„è¦‹ãƒ»è€ƒå¯Ÿ": [1-10ã®æ•´æ•°]
}}
```

## ç·åˆè©•ä¾¡
[20ç‚¹æº€ç‚¹ä¸­ã®å¾—ç‚¹ã¨å…¨ä½“çš„ãªã‚³ãƒ¡ãƒ³ãƒˆ]

## èª²é¡Œ1: æ—¥æœ¬èªè¨³ã®è©•ä¾¡
**è‰¯ã„ç‚¹:**
- [å…·ä½“çš„ãªè‰¯ã„ç‚¹ã‚’è¨˜è¿°ã€‚ã©ã®è¡¨ç¾ãŒè‰¯ã‹ã£ãŸã‹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚]

**æ”¹å–„ç‚¹:**
- [å…·ä½“çš„ãªæ”¹å–„ç‚¹ã‚’è¨˜è¿°ã€‚ã©ã®è¡¨ç¾ãŒæ”¹å–„ã™ã¹ãã‹ã€‚ã¾ãŸã€æ”¹å–„ã™ã‚‹ã¨ã—ãŸã‚‰ã©ã®ã‚ˆã†ã«ã™ã¹ãã‹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚]

**æ¨¡ç¯„è¨³ä¾‹:**
- [é‡è¦ãªå°‚é–€ç”¨èªã‚„è¡¨ç¾ã«ã¤ã„ã¦ã€ã‚ˆã‚Šé©åˆ‡ãªæ—¥æœ¬èªè¡¨ç¾ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚]

## èª²é¡Œ2: æ„è¦‹ãƒ»è€ƒå¯Ÿã®è©•ä¾¡
**è‰¯ã„ç‚¹:**
- [å…·ä½“çš„ãªè‰¯ã„ç‚¹ã‚’è¨˜è¿°ã€‚ã©ã®è¦³ç‚¹ã‚„è«–ç†å±•é–‹ãŒè‰¯ã‹ã£ãŸã‹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚]

**æ”¹å–„ç‚¹:**
- [å…·ä½“çš„ãªæ”¹å–„ç‚¹ã‚’è¨˜è¿°ã€‚è«–ç†æ€§ã€ç†è§£åº¦ã€è€ƒå¯Ÿã®æ·±ã•ãªã©ã«ã¤ã„ã¦æ”¹å–„ã™ã¹ãç‚¹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚]

**è€ƒå¯Ÿã®ãƒ’ãƒ³ãƒˆ:**
- [ã“ã®è«–æ–‡ã«é–¢ã—ã¦ã€ã‚ˆã‚Šæ·±ã„è€ƒå¯Ÿã«ã¤ãªãŒã‚‹ã‚ˆã†ãªè¦³ç‚¹ã‚„è¦–ç‚¹ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚]

## å­¦ç¿’ã‚¢ãƒ‰ãƒã‚¤ã‚¹
[åŒ»å­¦è‹±èªèª­è§£åŠ›å‘ä¸Šã®ãŸã‚ã®å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹]
"""

def score_reading_stream(abstract, translation, opinion):
    """
    è‹±èªèª­è§£ï¼ˆç¿»è¨³+è€ƒå¯Ÿï¼‰ã®æå‡ºç‰©ã‚’æ¡ç‚¹ã—ã€çµæœã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§è¿”ã™ã€‚
    
    Args:
        abstract (str): åŸæ–‡Abstract
        translation (str): æ—¥æœ¬èªè¨³
        opinion (str): æ„è¦‹ãƒ»è€ƒå¯Ÿ
    
    Yields:
        æ¡ç‚¹çµæœã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒãƒ£ãƒ³ã‚¯
    """
    # å…¥åŠ›æ¤œè¨¼
    is_valid, error_msg = validate_reading_inputs(abstract, translation, opinion)
    if not is_valid:
        yield type('ErrorChunk', (), {'text': f"âŒ å…¥åŠ›ã‚¨ãƒ©ãƒ¼: {error_msg}"})()
        return
    
    try:
        client = genai.Client()
        prompt = get_reading_scoring_prompt(abstract, translation, opinion)
        
        # ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¿œç­”ã‚’ç”Ÿæˆ
        response_stream = client.models.generate_content_stream(
            model='gemini-2.5-pro',
            contents=prompt
        )
        
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
        if not response_stream:
            raise ScoringError("AIæ¡ç‚¹ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰å¿œç­”ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚")
        
        chunk_count = 0
        for chunk in response_stream:
            chunk_count += 1
            if hasattr(chunk, 'text') and chunk.text:
                yield chunk
            else:
                # ç„¡åŠ¹ãªãƒãƒ£ãƒ³ã‚¯ã®å ´åˆã¯è­¦å‘Šã‚’è¡¨ç¤º
                yield type('WarningChunk', (), {
                    'text': f"\nâš ï¸ [ãƒãƒ£ãƒ³ã‚¯{chunk_count}] å¿œç­”å½¢å¼ãŒäºˆæœŸã—ãªã„å½¢å¼ã§ã™ã€‚\n"
                })()
        
        # ãƒãƒ£ãƒ³ã‚¯ãŒå…¨ãå—ä¿¡ã•ã‚Œãªã‹ã£ãŸå ´åˆ
        if chunk_count == 0:
            raise ScoringError("æ¡ç‚¹çµæœã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚")
            
    except ScoringError as e:
        yield type('ErrorChunk', (), {'text': f"âŒ æ¡ç‚¹ã‚¨ãƒ©ãƒ¼: {str(e)}"})()
    except Exception as e:
        # äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
        error_msg = f"âŒ ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"
        if "quota" in str(e).lower():
            error_msg += "\n\nğŸ’¡ APIä½¿ç”¨é‡ã®ä¸Šé™ã«é”ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚"
        elif "authentication" in str(e).lower():
            error_msg += "\n\nğŸ’¡ APIèªè¨¼ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚APIã‚­ãƒ¼ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
        
        yield type('ErrorChunk', (), {'text': error_msg})()

def get_reading_score_distribution():
    """
    è‹±èªèª­è§£æ¡ç‚¹åŸºæº–ã®è©³ç´°èª¬æ˜ã‚’è¿”ã—ã¾ã™ã€‚
    
    Returns:
        dict: æ¡ç‚¹åŸºæº–ã®è©³ç´°
    """
    return {
        "æ—¥æœ¬èªè¨³": {
            "9-10ç‚¹": "å°‚é–€ç”¨èªã‚‚å«ã‚ã¦æ­£ç¢ºã«è¨³ã•ã‚Œã€è‡ªç„¶ã§æµæš¢ãªæ—¥æœ¬èª",
            "7-8ç‚¹": "æ¦‚ã­æ­£ç¢ºã§èª­ã¿ã‚„ã™ã„ãŒã€ä¸€éƒ¨ã«ä¸è‡ªç„¶ãªè¡¨ç¾ãŒã‚ã‚‹",
            "5-6ç‚¹": "åŸºæœ¬çš„ãªæ„å‘³ã¯ä¼ã‚ã‚‹ãŒã€èª¤è¨³ã‚„ä¸é©åˆ‡ãªè¡¨ç¾ãŒæ•£è¦‹ã•ã‚Œã‚‹",
            "3-4ç‚¹": "éƒ¨åˆ†çš„ã«æ­£ç¢ºã ãŒã€é‡è¦ãªèª¤è¨³ã‚„è„±è½ãŒã‚ã‚‹",
            "1-2ç‚¹": "å¤§éƒ¨åˆ†ãŒä¸æ­£ç¢ºã¾ãŸã¯ç†è§£å›°é›£"
        },
        "æ„è¦‹ãƒ»è€ƒå¯Ÿ": {
            "9-10ç‚¹": "æ·±ã„æ´å¯Ÿã¨ç‹¬å‰µæ€§ãŒã‚ã‚Šã€è«–ç†çš„ã§èª¬å¾—åŠ›ã®ã‚ã‚‹è€ƒå¯Ÿ",
            "7-8ç‚¹": "é©åˆ‡ãªç†è§£ã«åŸºã¥ãå¦¥å½“ãªè€ƒå¯Ÿã§ã€è«–ç†æ€§ã‚‚ã‚ã‚‹",
            "5-6ç‚¹": "åŸºæœ¬çš„ãªç†è§£ã¯ã‚ã‚‹ãŒã€è€ƒå¯Ÿã®æ·±ã•ã‚„ç‹¬å‰µæ€§ã«æ¬ ã‘ã‚‹",
            "3-4ç‚¹": "éƒ¨åˆ†çš„ç†è§£ã«åŸºã¥ãè¡¨é¢çš„ãªè€ƒå¯Ÿ",
            "1-2ç‚¹": "ç†è§£ä¸è¶³ã§è«–ç†æ€§ã«æ¬ ã‘ã‚‹"
        }
    }
